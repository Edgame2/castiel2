# Baseline Behavior Report

**Date**: Week 0 Verification  
**Purpose**: Document current behavior of AI system components before making changes

---

## Executive Summary

This report documents the current baseline behavior of key AI system components as established during Week 0 verification testing. This baseline will be used to:
1. Verify improvements after implementation
2. Identify regression issues
3. Measure performance improvements
4. Guide optimization decisions

---

## 1. Change Feed Processor

### Current Status
- ‚úÖ **Service Exists**: `ShardEmbeddingChangeFeedService` is implemented
- ‚úÖ **Initialized**: Service is initialized in `apps/api/src/routes/index.ts` (lines 697-715)
- ‚ö†Ô∏è **Status Unknown**: Need to verify if actually running in production

### Current Behavior
- Listens to Cosmos DB change feed on shards container
- Processes shard changes in batches (default: 100 items)
- Polls every 5 seconds when no changes
- Processes with concurrency limit (default: 5 parallel)
- Skips shards with:
  - Recent vectors (< 7 days old)
  - Archived/deleted status
  - No structured data
- Supports two modes:
  - `generate`: Generate embeddings directly
  - `enqueue`: Enqueue jobs to Service Bus

### Statistics Tracked
- `shardsProcessed`: Total shards processed
- `embeddingsGenerated`: Successful embeddings
- `errors`: Failed processing attempts
- `skipped`: Skipped shards
- `jobsEnqueued`: Jobs sent to queue
- `isRunning`: Current running status
- `lastProcessedAt`: Last processing timestamp

### Gaps Identified
- ‚ö†Ô∏è **Verification Needed**: Not confirmed if running in production
- ‚ö†Ô∏è **Error Recovery**: Need to verify error handling is robust
- ‚ö†Ô∏è **Monitoring**: Need to verify statistics are being tracked

---

## 2. Global Chat

### Current Status
- ‚úÖ **UI Component**: `ChatInterface` supports `scope: 'global'` prop
- ‚úÖ **API Endpoint**: `/api/v1/insights/chat` supports `scopeMode: 'global'`
- ‚ö†Ô∏è **Context Assembly**: Uses generic context, not optimized for global

### Current Behavior

#### Context Assembly
- **RAG Search**: Uses `vectorSearch.search()` with:
  - `topK: 10` (RAG_TOP_K constant)
  - `minScore: 0.7` (RAG_MIN_SCORE constant)
  - No project filtering (tenant-wide search)
- **No Optimization**: Same parameters as project chat
- **No Caching**: No caching for global context

#### Prompt Usage
- **Generic Prompts**: Uses same hardcoded `SYSTEM_PROMPTS` as project chat
- **No Global-Specific Prompts**: No prompts that emphasize tenant-wide knowledge
- **Prompt System**: Not used (hardcoded prompts)

#### Performance
- **Response Time**: Not measured (baseline needed)
- **Context Size**: Typically 10 RAG chunks
- **Token Usage**: Not optimized

### Gaps Identified
1. **TopK Too Low**: Global should use 15 (vs 10) for broader search
2. **MinScore Too High**: Global could use 0.65 (vs 0.7) for more results
3. **No Caching**: Global context not cached
4. **No Global Prompts**: Uses generic prompts
5. **No Tenant-Wide Optimization**: Doesn't prioritize tenant-wide knowledge

### Comparison with Project Chat
| Aspect | Global Chat | Project Chat |
|--------|-------------|--------------|
| TopK | 10 | 10 (from ProjectContextService may differ) |
| MinScore | 0.7 | 0.7 |
| Project Filtering | No | Yes |
| Uses ProjectContextService | No | Yes |
| Caching | No | Yes (5 min TTL) |
| Prompts | Generic | Generic |
| Context Optimization | No | Yes |

---

## 3. RAG Integration

### Current Status
- ‚úÖ **Implemented**: RAG retrieval exists in `assembleContext()` (lines 849-906)
- ‚úÖ **Vector Search**: Integrated with `VectorSearchService`
- ‚ö†Ô∏è **Verification Needed**: Need to confirm RAG chunks are in LLM context

### Current Behavior

#### RAG Retrieval
- **Called When**: 
  - Vector search is available
  - AND (no scopeMode OR scopeMode !== 'project' OR no projectContextService)
- **Parameters**:
  - `topK: 10` (RAG_TOP_K)
  - `minScore: 0.7` (RAG_MIN_SCORE)
- **Filtering**: 
  - Project scope: Filters by project relationships (20% unlinked allowance)
  - Global scope: No filtering

#### RAG Chunk Format
```typescript
{
  id: string (UUID),
  shardId: string,
  shardName: string,
  shardTypeId: string,
  content: string,
  chunkIndex: number,
  score: number,
  highlight?: string,
  tokenCount: number,
}
```

#### Citations
- **Generated By**: GroundingService (if available)
- **Format**: Inline citations like [1], [2]
- **Status**: Need to verify citations are generated

### Gaps Identified
1. **Global RAG Not Optimized**: Uses same topK/minScore as project
2. **No Field Weighting**: Results not weighted by field importance
3. **No Template Integration**: Queries don't use embedding templates
4. **Verification Needed**: Not confirmed RAG chunks are in formatted context

---

## 4. Shard-Specific Q&A

### Current Status
- ‚úÖ **Service Exists**: `ContextAwareQueryParserService` is implemented
- ‚úÖ **Integrated in Routes**: Used in `insights.routes.ts` (lines 197-218)
- ‚ùå **NOT Integrated in InsightService**: Not called in `InsightService.generate()`

### Current Behavior

#### Entity Parsing
- **Detects**: Natural language entity references and @mentions
- **Resolves**: Entity names to shard IDs via `EntityResolutionService`
- **Limitation**: Takes best match only (limit: 1)

#### Query Enhancement
- **Enhances Query**: Adds entity context to query text
- **Entity Context**: Includes shard content in `entityContext` array
- **Usage**: Enhanced query is passed to `InsightService.generate()`

#### Single-Shard Optimization
- **Current**: NOT implemented
- **Behavior**: Uses generic context assembly even for single-shard questions
- **Gap**: Should optimize to use only specific shard content

### Integration Points

#### ‚úÖ Integrated
- `apps/api/src/routes/insights.routes.ts` (lines 197-218)
  - Parses query before calling `InsightService.generate()`
  - Enhances query with entity context
  - Logs entity resolution

#### ‚ùå NOT Integrated
- `apps/api/src/services/insight.service.ts`
  - `generate()` method does NOT call `ContextAwareQueryParserService`
  - Does NOT optimize context for single-shard questions
  - Uses generic context assembly

### Gaps Identified
1. **No Single-Shard Optimization**: Generic context even for specific shard questions
2. **No Pronoun Resolution**: Doesn't resolve "it", "that", "this" in follow-ups
3. **Limited Disambiguation**: Takes best match, doesn't handle ambiguous names well
4. **Not in InsightService**: Only used in routes, not in service layer

---

## 5. Prompt System

### Current Status
- ‚úÖ **Infrastructure**: Excellent prompt system infrastructure exists
- ‚ùå **Not Used**: `InsightService` uses hardcoded `SYSTEM_PROMPTS` instead

### Current Behavior

#### Hardcoded Prompts
- **Location**: `apps/api/src/services/insight.service.ts` (lines 72-87)
- **Format**: `Record<InsightType, string>`
- **Types**: summary, analysis, comparison, recommendation, prediction, extraction, search, generation
- **Usage**: Directly used in `buildPrompts()` method (line 1072)

#### Prompt System Infrastructure
- ‚úÖ `PromptRepository` - Full CRUD operations
- ‚úÖ `PromptResolverService` - Precedence resolution (User > Tenant > System)
- ‚úÖ `PromptRendererService` - Template rendering
- ‚úÖ `PromptABTestService` - A/B testing framework
- ‚úÖ System prompts seeded in `data/prompts/system-prompts.json`

#### System Prompts Available
- `insights-summary`
- `insights-analysis`
- `insights-comparison`
- `insights-recommendation`
- `insights-prediction`
- `insights-extraction`
- `insights-search`
- `insights-generation`

### Gaps Identified
1. **Not Integrated**: `InsightService` doesn't use `PromptResolverService`
2. **No Global Prompts**: No global-chat specific prompts
3. **No Project Prompts**: No project-specific prompts
4. **No Versioning**: Version field exists but not used
5. **No Analytics**: Can't track prompt performance

---

## 6. VectorizationService

### Current Status
- ‚ö†Ô∏è **Legacy Service**: Doesn't use `EmbeddingTemplateService`
- ‚ö†Ô∏è **Routes Not Registered**: Routes may not be active
- ‚ö†Ô∏è **Usage Unknown**: Need to verify if actively used

### Current Behavior
- Uses `extractTextFromShard()` utility (no templates)
- Uses `chunkText()` with configurable strategy (no template rules)
- Uses `prepareTextForEmbedding()` (basic normalization)
- Direct `AzureOpenAIService` calls (no template model selection)
- Stores vectors in shard document

### Gaps Identified
1. **No Template Integration**: Doesn't use `EmbeddingTemplateService`
2. **No Field Weighting**: All fields treated equally
3. **No Shard-Type-Specific Processing**: Generic for all types
4. **Routes Not Verified**: Need to check if routes are registered

---

## 7. Vector Search

### Current Status
- ‚úÖ **Well Implemented**: Comprehensive vector search service
- ‚ö†Ô∏è **Template Integration**: Queries don't use embedding templates

### Current Behavior

#### Query Embedding Generation
- **Current**: Uses basic text preprocessing
- **Missing**: Doesn't use `EmbeddingTemplateService` for query preprocessing
- **Impact**: Inconsistent normalization between queries and documents

#### Result Scoring
- **Current**: Uses cosine similarity score
- **Missing**: No field-weighted scoring
- **Impact**: All fields treated equally, no importance weighting

#### Template Integration
- **Current**: `EmbeddingTemplateService` is optional dependency
- **Missing**: Not used for query preprocessing
- **Impact**: Queries and documents may be normalized differently

### Gaps Identified
1. **No Query Template Preprocessing**: Queries don't use templates
2. **No Field Weighting**: Results not weighted by field importance
3. **Template Service Optional**: Should be required for consistency

---

## Performance Baselines

### Response Times (To Be Measured)
- Global Chat: _TBD_
- Project Chat: _TBD_
- Shard-Specific Q&A: _TBD_

### Context Assembly Times (To Be Measured)
- RAG Retrieval: _TBD_
- Context Formatting: _TBD_
- Total Assembly: _TBD_

### Token Usage (To Be Measured)
- Global Chat Context: _TBD_
- Project Chat Context: _TBD_
- Shard Q&A Context: _TBD_

---

## Summary of Gaps

### Critical Gaps (Priority 1)
1. ‚ùå **Prompt System Not Used** - Hardcoded prompts instead of prompt system
2. ‚ùå **Global Chat Not Optimized** - Uses same parameters as project chat
3. ‚ùå **VectorizationService Legacy** - Doesn't use templates
4. ‚ö†Ô∏è **Change Feed Status Unknown** - Need to verify if running

### High Priority Gaps (Priority 2)
5. ‚ö†Ô∏è **Vector Search Templates** - Queries don't use templates
6. ‚ö†Ô∏è **Shard Q&A Not Optimized** - No single-shard context optimization
7. ‚ö†Ô∏è **RAG Verification** - Need to confirm RAG chunks in context

### Medium Priority Gaps (Priority 3)
8. ‚ö†Ô∏è **Conversation Context** - Limited follow-up handling
9. ‚ö†Ô∏è **Function Calling** - Not implemented
10. ‚ö†Ô∏è **Model Selection Config** - Not configurable

---

## Test Results Summary

### Change Feed Processor Tests
- ‚úÖ Service can be created and started
- ‚úÖ Statistics tracking works
- ‚ö†Ô∏è Need to verify actual processing in production

### Global Chat Baseline Tests
- ‚úÖ Global scope queries are handled
- ‚úÖ RAG retrieval works (with mocks)
- ‚ö†Ô∏è Need to verify actual behavior in production
- ‚ö†Ô∏è Documented gaps: topK, minScore, caching, prompts

### RAG Verification Tests
- ‚úÖ RAG retrieval works
- ‚úÖ Filtering by score works
- ‚úÖ TopK limiting works
- ‚ö†Ô∏è Need to verify RAG chunks are in formatted context

### Shard-Specific Q&A Tests
- ‚úÖ Entity parsing works
- ‚úÖ Entity resolution works
- ‚úÖ Service is integrated in routes
- ‚ùå NOT integrated in InsightService
- ‚ùå No single-shard optimization

---

## Recommendations

### Immediate (Week 0)
1. ‚úÖ Run verification tests in test environment
2. ‚úÖ Document baseline behavior (this report)
3. ‚ö†Ô∏è Verify Change Feed processor is running
4. ‚ö†Ô∏è Test actual global chat in production-like environment

### Week 1
1. Integrate prompt system into InsightService
2. Migrate VectorizationService to use templates
3. Optimize global chat with tenant-wide RAG
4. Create global-specific prompts

### Week 2
1. Integrate vector search templates
2. Optimize shard-specific Q&A
3. Add global context caching

---

## Next Steps

1. **Run Tests**: Execute all verification tests
2. **Measure Baselines**: Capture performance metrics
3. **Verify Production**: Check actual running status
4. **Begin Implementation**: Start Week 1 tasks

---

## Appendix: Test Files Created

1. `apps/api/tests/embedding/change-feed-processor.verification.test.ts`
2. `apps/api/tests/ai-insights/global-chat-baseline.test.ts`
3. `apps/api/tests/ai-insights/rag-verification.test.ts`
4. `apps/api/tests/ai-insights/shard-specific-qa.test.ts`

## Appendix: Audit Documents Created

1. `docs/verification/vectorization-service-audit.md`
2. `docs/verification/baseline-behavior-report.md` (this document)

---

## üîç Gap Analysis

### Current Implementation Status**Status:** ‚úÖ **Complete** - Baseline behavior report fully documented#### Implemented Features (‚úÖ)- ‚úÖ Baseline behavior documented
- ‚úÖ Current status documented
- ‚úÖ Gaps identified
- ‚úÖ Test files created#### Known Limitations

- ‚ö†Ô∏è **Verification Status** - Some components may need verification
  - **Code Reference:**
    - Change feed processor status unknown
  - **Recommendation:**
    1. Verify component status
    2. Update baseline report
    3. Document verification results

- ‚ö†Ô∏è **Baseline Updates** - Baseline may need updates after changes
  - **Recommendation:**
    1. Update baseline after improvements
    2. Document changes
    3. Track improvements

### Related Documentation

- [Gap Analysis](../GAP_ANALYSIS.md) - Comprehensive gap analysis
- [Vectorization Service Audit](./vectorization-service-audit.md) - Service audit
- [Backend Documentation](../backend/README.md) - Backend implementation
