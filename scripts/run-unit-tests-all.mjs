#!/usr/bin/env node
/**
 * Run test:unit for each container and collect failures.
 * Writes unit-test-run.log and documentation/notes/unit-test-failures.md
 */
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import { spawnSync } from 'child_process';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const ROOT = path.resolve(__dirname, '..');
const CONTAINERS_DIR = path.join(ROOT, 'containers');

const containers = fs.readdirSync(CONTAINERS_DIR).filter((c) => {
  const pkgPath = path.join(CONTAINERS_DIR, c, 'package.json');
  if (!fs.existsSync(pkgPath)) return false;
  try {
    const pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf8'));
    return pkg?.scripts && ('test' in pkg.scripts || 'test:unit' in pkg.scripts);
  } catch {
    return false;
  }
}).sort();

const failures = [];
const logLines = [];

for (const name of containers) {
  const cwd = path.join(CONTAINERS_DIR, name);
  logLines.push(`\n=== ${name} ===\n`);
  const result = spawnSync('pnpm', ['run', 'test:unit'], {
    cwd,
    encoding: 'utf8',
    timeout: 120000,
  });
  const out = (result.stdout || '') + (result.stderr || '');
  logLines.push(out);
  if (result.status !== 0) {
    failures.push({ name, status: result.status, output: out });
  }
}

const logPath = path.join(ROOT, 'unit-test-run.log');
fs.writeFileSync(logPath, logLines.join(''), 'utf8');
console.log('Wrote', logPath);

const failureReport = [
  '# Unit test failures report',
  '',
  'Generated by `node scripts/run-unit-tests-all.mjs`',
  '',
  `Total containers: ${containers.length}`,
  `Failed: ${failures.length}`,
  '',
  'Full log: [unit-test-run.log](../../unit-test-run.log)',
  '',
  '## Failures by container',
  '',
];

for (const f of failures) {
  failureReport.push(`### ${f.name}`);
  failureReport.push('');
  const excerpt = f.output.split('\n').slice(-40).join('\n');
  failureReport.push('```');
  failureReport.push(excerpt.replace(/```/g, '`'.repeat(3)));
  failureReport.push('```');
  failureReport.push('');
}

const reportPath = path.join(ROOT, 'documentation', 'notes', 'unit-test-failures.md');
fs.mkdirSync(path.dirname(reportPath), { recursive: true });
fs.writeFileSync(reportPath, failureReport.join('\n'), 'utf8');
console.log('Wrote', reportPath);
console.log('Failed containers:', failures.map((f) => f.name).join(', ') || 'none');
process.exit(failures.length > 0 ? 1 : 0);
