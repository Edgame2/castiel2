openapi: 3.0.3
info:
  title: Migration Service API
  version: 1.0.0
  description: |
    Code migrations and refactoring service.
    
    ## Authentication
    All endpoints require JWT authentication via Bearer token.
    
    ## Migration Types
    - Refactoring: Code refactoring migrations
    - Version Upgrade: Version upgrade migrations
    - Breaking Change: Breaking change migrations
    - Performance: Performance improvement migrations
    - Security: Security update migrations

servers:
  - url: /api/v1
    description: API Version 1

tags:
  - name: Migrations
    description: Migration management
  - name: Migration Steps
    description: Migration step management
  - name: Health
    description: Health check endpoints

paths:
  /migrations:
    post:
      summary: Create migration
      description: Create a new migration
      tags: [Migrations]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, type, target]
              properties:
                name:
                  type: string
                description:
                  type: string
                type:
                  type: string
                  enum: [refactoring, version_upgrade, breaking_change, performance, security, custom]
                target:
                  type: object
                  required: [type, path]
                fromVersion:
                  type: string
                toVersion:
                  type: string
      responses:
        '201':
          description: Migration created
        '400':
          description: Bad request
        '401':
          description: Unauthorized
    
    get:
      summary: List migrations
      description: List migrations with filtering
      tags: [Migrations]
      security:
        - bearerAuth: []
      parameters:
        - name: type
          in: query
          schema:
            type: string
        - name: status
          in: query
          schema:
            type: string
            enum: [draft, planned, running, completed, failed, rolled_back]
        - name: limit
          in: query
          schema:
            type: number
            default: 100
        - name: continuationToken
          in: query
          schema:
            type: string
      responses:
        '200':
          description: List of migrations
        '401':
          description: Unauthorized
  
  /migrations/{id}:
    get:
      summary: Get migration
      description: Get migration by ID
      tags: [Migrations]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Migration details
        '404':
          description: Not found
        '401':
          description: Unauthorized
    
    put:
      summary: Update migration
      description: Update migration
      tags: [Migrations]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                description:
                  type: string
                status:
                  type: string
                  enum: [draft, planned, running, completed, failed, rolled_back]
                result:
                  type: object
                error:
                  type: string
      responses:
        '200':
          description: Migration updated
        '404':
          description: Not found
        '401':
          description: Unauthorized
    
    delete:
      summary: Delete migration
      description: Delete migration
      tags: [Migrations]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Migration deleted
        '404':
          description: Not found
        '401':
          description: Unauthorized
  
  /migrations/{id}/execute:
    post:
      summary: Execute migration
      description: Execute a migration
      tags: [Migrations]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Migration execution started
        '404':
          description: Not found
        '401':
          description: Unauthorized
  
  /migrations/{id}/rollback:
    post:
      summary: Rollback migration
      description: Rollback a migration
      tags: [Migrations]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                reason:
                  type: string
      responses:
        '200':
          description: Migration rollback started
        '404':
          description: Not found
        '401':
          description: Unauthorized
  
  /migrations/{id}/steps:
    post:
      summary: Create migration step
      description: Create a new migration step
      tags: [Migration Steps]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [order, name, type]
              properties:
                order:
                  type: number
                name:
                  type: string
                description:
                  type: string
                type:
                  type: string
                  enum: [transformation, validation, rollback]
                transformation:
                  type: object
                validation:
                  type: object
                rollback:
                  type: object
      responses:
        '201':
          description: Step created
        '400':
          description: Bad request
        '401':
          description: Unauthorized
    
    get:
      summary: List migration steps
      description: List steps for a migration
      tags: [Migration Steps]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List of steps
        '404':
          description: Not found
        '401':
          description: Unauthorized
  
  /migration-steps/{id}:
    get:
      summary: Get migration step
      description: Get migration step by ID
      tags: [Migration Steps]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Step details
        '404':
          description: Not found
        '401':
          description: Unauthorized
    
    put:
      summary: Update migration step status
      description: Update migration step status
      tags: [Migration Steps]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [status]
              properties:
                status:
                  type: string
                  enum: [pending, running, completed, failed, skipped]
                result:
                  type: object
                errorMessage:
                  type: string
      responses:
        '200':
          description: Step updated
        '404':
          description: Not found
        '401':
          description: Unauthorized
    
    delete:
      summary: Delete migration step
      description: Delete migration step
      tags: [Migration Steps]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Step deleted
        '404':
          description: Not found
        '401':
          description: Unauthorized
  
  /health:
    get:
      summary: Health check
      description: Liveness probe
      tags: [Health]
      responses:
        '200':
          description: Service is healthy
  
  /ready:
    get:
      summary: Readiness check
      description: Readiness probe
      tags: [Health]
      responses:
        '200':
          description: Service is ready
        '503':
          description: Service is not ready

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

