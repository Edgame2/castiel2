# Document Chunk Architecture Diagrams

**Purpose**: Visual reference for `c_documentChunk` architecture  
**Created**: December 15, 2025

---

## 1. Data Model & Relationships

### Shard Hierarchy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     c_document                              â”‚
â”‚                   (Parent Shard)                            â”‚
â”‚                                                              â”‚
â”‚  â”œâ”€ name: "Sales Proposal Q1 2025.pdf"                    â”‚
â”‚  â”œâ”€ fileSize: 2456789                                      â”‚
â”‚  â”œâ”€ storageProvider: "azure"                               â”‚
â”‚  â””â”€ storagePath: "/tenant-xyz/documents/.../proposal.pdf"  â”‚
â”‚                                                              â”‚
â”‚  status: active                                             â”‚
â”‚  createdAt: 2025-01-15T10:00:00Z                           â”‚
â”‚  updatedAt: 2025-01-15T10:00:00Z                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
           (cascade parent-child relationship)
                      â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                         â”‚             â”‚            â”‚
         â–¼                         â–¼             â–¼            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚c_documentChunk       â”‚c_documentChunk   â”‚c_documentChunk
    â”‚                      â”‚                 â”‚                â”‚
    â”‚ Chunk #1             â”‚ Chunk #2        â”‚ Chunk #3       â”‚ Chunk #N
    â”‚ (Executive)          â”‚ (Timeline)      â”‚ (Pricing)      â”‚ (Terms)
    â”‚                      â”‚                 â”‚                â”‚
    â”‚ embeddingStatus:     â”‚ embeddingStatus:â”‚ embeddingStatus:
    â”‚  "complete"          â”‚  "complete"     â”‚  "pending"     â”‚
    â”‚                      â”‚                 â”‚                â”‚
    â”‚ embedding: [0.12..   â”‚ embedding: [... â”‚ embedding:     â”‚
    â”‚ (1536 dims)          â”‚ (1536 dims)     â”‚ null           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                      â”‚                  â”‚              â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    (cascade delete on parent removal)
```

---

## 2. Chunk Lifecycle State Machine

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CHUNK LIFECYCLE                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚   CREATED    â”‚
                            â”‚              â”‚
                            â”‚ embeddingStatus
                            â”‚   = 'pending'
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                                     â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚                                       â”‚
                 â–¼                                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  EMBEDDING       â”‚ success          â”‚    EMBEDDING     â”‚
        â”‚  PROCESSING      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º   â”‚   COMPLETE       â”‚
        â”‚                  â”‚                  â”‚                  â”‚
        â”‚ embeddingStatus  â”‚                  â”‚ embeddingStatus  â”‚
        â”‚   = 'processing' â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚   = 'complete'   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ retry            â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                                  â”‚
                 â”‚ error                            â”‚
                 â–¼                                  â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
        â”‚  EMBEDDING       â”‚                       â”‚
        â”‚  FAILED          â”‚                       â”‚
        â”‚                  â”‚                       â”‚
        â”‚ embeddingStatus  â”‚                       â”‚
        â”‚   = 'failed'     â”‚                       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
                                                   â”‚
           (New embedding model,               (delete)
            re-chunking, etc.)                     â”‚
                                                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  DEPRECATED      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚    DELETED       â”‚
        â”‚                  â”‚ model change â”‚                  â”‚
        â”‚ embeddingStatus  â”‚              â”‚ status = 'deleted'
        â”‚   = 'deprecated' â”‚              â”‚                  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               (hard or soft)
```

---

## 3. Cascade Delete Flow

### Hard Delete (Permanent Removal)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User requests: DELETE /api/documents/{documentId}                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Validate document     â”‚
                    â”‚  exists & user has    â”‚
                    â”‚  delete permission    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  Query for all chunks with     â”‚
                â”‚  documentId = {docId}          â”‚
                â”‚  tenantId = {tenantId}         â”‚
                â”‚  status != 'deleted'           â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Found N chunks        â”‚
                    â”‚  N = [0..10000+]       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ For each chunk (batch delete)                   â”‚
        â”‚                                                  â”‚
        â”‚  1. Delete chunk vectors from index             â”‚
        â”‚  2. Delete chunk embeddings from storage        â”‚
        â”‚  3. Hard delete chunk document                  â”‚
        â”‚  4. Log to audit trail                          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚  All chunks deleted          â”‚
                 â”‚  (hard delete complete)      â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚  Hard delete parent         â”‚
                 â”‚  document from storage      â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚  Create audit log entry     â”‚
                 â”‚  CASCADE_DELETE event:      â”‚
                 â”‚  - parentId: {documentId}   â”‚
                 â”‚  - parentType: c_document   â”‚
                 â”‚  - cascadeCount: N          â”‚
                 â”‚  - deletedChunkIds: [...]   â”‚
                 â”‚  - performedBy: {userId}    â”‚
                 â”‚  - timestamp: now()         â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚  Return response            â”‚
                 â”‚  {                          â”‚
                 â”‚    documentDeleted: true,   â”‚
                 â”‚    chunksDeleted: N,        â”‚
                 â”‚    cascadeDetails: {...}    â”‚
                 â”‚  }                          â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  âœ… COMPLETE    â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Soft Delete (Logical Deletion)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User requests: DELETE /api/documents/{documentId}?soft=true            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚  Set now = current datetime  â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Soft delete all chunks (UPDATE query)          â”‚
        â”‚                                                  â”‚
        â”‚  UPDATE document_chunks                         â”‚
        â”‚  SET deletedAt = @now,                          â”‚
        â”‚      deletedBy = @userId,                       â”‚
        â”‚      status = 'deleted'                         â”‚
        â”‚  WHERE documentId = @docId                      â”‚
        â”‚    AND tenantId = @tenantId                     â”‚
        â”‚    AND status != 'deleted'                      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚  Updated M chunks            â”‚
                 â”‚  M = [0..N] (some may       â”‚
                 â”‚   already be deleted)       â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚  Soft delete parent         â”‚
                 â”‚  document (UPDATE query)    â”‚
                 â”‚                              â”‚
                 â”‚  UPDATE documents           â”‚
                 â”‚  SET deletedAt = @now,      â”‚
                 â”‚      deletedBy = @userId,   â”‚
                 â”‚      status = 'deleted'     â”‚
                 â”‚  WHERE id = @docId          â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚  Create audit log entry     â”‚
                 â”‚  CASCADE_SOFT_DELETE event  â”‚
                 â”‚  - parentId: {documentId}   â”‚
                 â”‚  - cascadeCount: M          â”‚
                 â”‚  - reason: "PARENT_SOFT_    â”‚
                 â”‚    DELETED"                 â”‚
                 â”‚  - timestamp: now()         â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚  Query filters updated      â”‚
                 â”‚  All SELECT queries now     â”‚
                 â”‚  automatically exclude:     â”‚
                 â”‚  WHERE status != 'deleted'  â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  âœ… COMPLETE    â”‚
                        â”‚                 â”‚
                        â”‚  Data retained  â”‚
                        â”‚  for recovery   â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. Embedding Generation Pipeline

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   EMBEDDING GENERATION PIPELINE                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                               â”‚
         â–¼                                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  New Chunks      â”‚                          â”‚  Chunk Sync      â”‚
â”‚  Created         â”‚                          â”‚  (e.g., PDF re-  â”‚
â”‚                  â”‚                          â”‚   chunking)      â”‚
â”‚  embeddingStatus:â”‚                          â”‚                  â”‚
â”‚   'pending'      â”‚                          â”‚  embeddingStatus:â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                          â”‚   'deprecated'   â”‚
             â”‚                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
             â”‚                                            â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚   Batch Queue Job          â”‚
                 â”‚  (every 5 minutes)         â”‚
                 â”‚                            â”‚
                 â”‚  SELECT chunks             â”‚
                 â”‚  WHERE embeddingStatus     â”‚
                 â”‚    IN ('pending',          â”‚
                 â”‚        'deprecated')       â”‚
                 â”‚  LIMIT 100                 â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚  Validate chunks:          â”‚
                 â”‚  - Parent doc still exists â”‚
                 â”‚  - Content unchanged      â”‚
                 â”‚  - Content hash valid      â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                               â”‚
        â–¼                                               â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Set embeddingStatus =      â”‚        â”‚  Skip invalid chunks     â”‚
   â”‚    'processing'             â”‚        â”‚  Notify admins           â”‚
   â”‚                             â”‚        â”‚                          â”‚
   â”‚  Update timestamps          â”‚        â”‚  Return to 'pending'     â”‚
   â”‚  Assign batch ID            â”‚        â”‚  for manual investigationâ”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Call Embedding API         â”‚
   â”‚  (OpenAI, Ollama, etc.)     â”‚
   â”‚                             â”‚
   â”‚  POST /embeddings           â”‚
   â”‚  {                          â”‚
   â”‚    model: "text-embedding-  â”‚
   â”‚            3-small",        â”‚
   â”‚    input: [                 â”‚
   â”‚      chunk1.content,        â”‚
   â”‚      chunk2.content,        â”‚
   â”‚      ...                    â”‚
   â”‚    ]                        â”‚
   â”‚  }                          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                       â”‚
    â–¼                       â–¼
 Success              Error/Timeout
    â”‚                       â”‚
    â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         â”‚                            â”‚
    â”‚         â–¼                            â–¼
    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    â”‚  Retry (exponential backoff)â”‚ â”‚  Max retries     â”‚
    â”‚    â”‚  - Attempt 1: 30 seconds    â”‚ â”‚  exceeded?       â”‚
    â”‚    â”‚  - Attempt 2: 2 minutes     â”‚ â”‚                  â”‚
    â”‚    â”‚  - Attempt 3: 10 minutes    â”‚ â”‚  Yes:            â”‚
    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  Set status =    â”‚
    â”‚         â”‚         â”‚      â”‚          â”‚   'failed'       â”‚
    â”‚         â”‚         â”‚      â””â”€â”€â”€â”€â”€â”€â–º   â”‚  Alert admin     â”‚
    â”‚         â”‚         â”‚                 â”‚  Log error       â”‚
    â”‚         â”‚         â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚         â–¼         â–¼
    â”‚    Success (retries)
    â”‚         â”‚
    â–¼         â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚  Receive embeddings from API     â”‚
 â”‚                                   â”‚
 â”‚  {                               â”‚
 â”‚    data: [                       â”‚
 â”‚      { embedding: [0.12, ...] }, â”‚
 â”‚      { embedding: [0.34, ...] }, â”‚
 â”‚      ...                         â”‚
 â”‚    ]                            â”‚
 â”‚  }                              â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚  Store embeddings:       â”‚
 â”‚                          â”‚
 â”‚  1. Insert into          â”‚
 â”‚     chunk_embeddings     â”‚
 â”‚     table (vectors)      â”‚
 â”‚                          â”‚
 â”‚  2. Update chunk_docum   â”‚
 â”‚     ents with:           â”‚
 â”‚     - embeddingStatus =  â”‚
 â”‚       'complete'         â”‚
 â”‚     - embeddingTimestamp â”‚
 â”‚       = now()            â”‚
 â”‚     - embeddingDimensionsâ”‚
 â”‚       = 1536             â”‚
 â”‚                          â”‚
 â”‚  3. Create vector index  â”‚
 â”‚     for similarity searchâ”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚  Log completion:          â”‚
 â”‚  - chunks processed: 100  â”‚
 â”‚  - success rate: 99%      â”‚
 â”‚  - avg latency: 1.2s      â”‚
 â”‚  - total cost: $0.10      â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  âœ… COMPLETE   â”‚
     â”‚                â”‚
     â”‚  Chunks ready  â”‚
     â”‚  for semantic  â”‚
     â”‚  search        â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. Semantic Search Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         SEMANTIC SEARCH                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  User Query: "data governance policies"         â”‚
        â”‚                                                  â”‚
        â”‚  POST /api/chunks/search                        â”‚
        â”‚  {                                              â”‚
        â”‚    query: "data governance policies",           â”‚
        â”‚    topK: 10,                                    â”‚
        â”‚    minSimilarity: 0.7,                          â”‚
        â”‚    documentId: "doc-xyz" (optional)             â”‚
        â”‚  }                                              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  1. Embed the query                             â”‚
        â”‚                                                  â”‚
        â”‚  POST /embeddings                               â”‚
        â”‚  {                                              â”‚
        â”‚    model: "text-embedding-3-small",             â”‚
        â”‚    input: "data governance policies"            â”‚
        â”‚  }                                              â”‚
        â”‚                                                  â”‚
        â”‚  â†’ queryVector: [0.45, -0.12, 0.89, ...]       â”‚
        â”‚                 (1536 dimensions)               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  2. Vector similarity search                    â”‚
        â”‚                                                  â”‚
        â”‚  SELECT                                         â”‚
        â”‚    chunkId,                                     â”‚
        â”‚    name,                                        â”‚
        â”‚    documentName,                                â”‚
        â”‚    COSINE_SIMILARITY(embedding,                â”‚
        â”‚                      @queryVector)             â”‚
        â”‚      as similarity                              â”‚
        â”‚  FROM chunk_embeddings                          â”‚
        â”‚  WHERE tenantId = @tenantId                     â”‚
        â”‚    AND embeddingStatus = 'complete'             â”‚
        â”‚    AND documentId = @docId (if provided)        â”‚
        â”‚  ORDER BY similarity DESC                       â”‚
        â”‚  LIMIT @topK                                    â”‚
        â”‚                                                  â”‚
        â”‚  Results:                                       â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
        â”‚  â”‚ Chunk 5: "Data Governance..."           â”‚   â”‚
        â”‚  â”‚ Similarity: 0.92 âœ… (>0.7)              â”‚   â”‚
        â”‚  â”‚ Document: "Governance Framework v2.1"   â”‚   â”‚
        â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
        â”‚  â”‚ Chunk 12: "Policy Frameworks..."        â”‚   â”‚
        â”‚  â”‚ Similarity: 0.88 âœ… (>0.7)              â”‚   â”‚
        â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
        â”‚  â”‚ Chunk 3: "Overview..."                  â”‚   â”‚
        â”‚  â”‚ Similarity: 0.81 âœ… (>0.7)              â”‚   â”‚
        â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
        â”‚  â”‚ Chunk 19: "Tools & Technology..."       â”‚   â”‚
        â”‚  â”‚ Similarity: 0.68 âŒ (<0.7, filtered)   â”‚   â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  3. Augment results with context               â”‚
        â”‚                                                  â”‚
        â”‚  For each result chunk:                         â”‚
        â”‚  - Get parent document name                     â”‚
        â”‚  - Get chunk sequence number                    â”‚
        â”‚  - Get surrounding chunks (context)             â”‚
        â”‚  - Get related chunks (same document)           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  4. Return ranked results                       â”‚
        â”‚                                                  â”‚
        â”‚  {                                              â”‚
        â”‚    query: "data governance policies",           â”‚
        â”‚    executionTime: "245ms",                      â”‚
        â”‚    totalMatches: 347,                           â”‚
        â”‚    returnsMatches: 3,                           â”‚
        â”‚    results: [                                   â”‚
        â”‚      {                                          â”‚
        â”‚        rank: 1,                                 â”‚
        â”‚        chunkId: "chunk-5-uuid",                 â”‚
        â”‚        name: "Data Governance...",              â”‚
        â”‚        documentId: "doc-1-uuid",                â”‚
        â”‚        documentName: "Governance...",           â”‚
        â”‚        chunkSequence: 5,                        â”‚
        â”‚        similarity: 0.92,                        â”‚
        â”‚        content: "This chapter...",              â”‚
        â”‚        excerpt: "...data governance...",        â”‚
        â”‚        metadata: {                              â”‚
        â”‚          pageNumber: 12,                        â”‚
        â”‚          sectionTitle: "Policies"               â”‚
        â”‚        }                                        â”‚
        â”‚      },                                         â”‚
        â”‚      { ... } // results 2-3                     â”‚
        â”‚    ]                                            â”‚
        â”‚  }                                              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  5. Display in UI                               â”‚
        â”‚                                                  â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
        â”‚  â”‚  Search Results (3 matches)             â”‚   â”‚
        â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
        â”‚  â”‚ ğŸ“„ Governance Framework v2.1            â”‚   â”‚
        â”‚  â”‚    â–º Data Governance Policies (92%)    â”‚   â”‚
        â”‚  â”‚    â–º Policy Frameworks (88%)           â”‚   â”‚
        â”‚  â”‚    â–º Overview (81%)                    â”‚   â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
        â”‚                                                  â”‚
        â”‚  Click on result â†’ Opens chunk in context      â”‚
        â”‚  with highlighting                              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  âœ… USER SEES   â”‚
                        â”‚     RESULTS     â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. Data Structure Diagram

### Document Chunk in Cosmos DB

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       COSMOS DB Document                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  {                                                                  â”‚
â”‚    "id": "chunk-001-abc123",              â† Unique ID              â”‚
â”‚    "tenantId": "tenant-xyz",              â† Partition key          â”‚
â”‚    "userId": "user-123",                  â† Creator                â”‚
â”‚    "shardTypeId": "c_documentChunk",      â† Type                   â”‚
â”‚    "parentShardId": "document-abc123",    â† Parent ref             â”‚
â”‚                                                                     â”‚
â”‚    â”Œâ”€â”€â”€ STRUCTURED DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚    â”‚                                                              â”‚â”‚
â”‚    â”‚  "structuredData": {                                        â”‚â”‚
â”‚    â”‚    "name": "Executive Summary",                             â”‚â”‚
â”‚    â”‚    "documentId": "document-abc123",                         â”‚â”‚
â”‚    â”‚    "documentName": "Q1 2025 Sales Proposal.pdf",           â”‚â”‚
â”‚    â”‚    "content": "This proposal outlines our comprehensive    â”‚â”‚
â”‚    â”‚               solution for enterprise data management...",  â”‚â”‚
â”‚    â”‚    "contentLength": 1245,                                  â”‚â”‚
â”‚    â”‚    "contentHash": "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6",     â”‚â”‚
â”‚    â”‚    "chunkSequence": 1,                                     â”‚â”‚
â”‚    â”‚    "chunkSize": 512,                                       â”‚â”‚
â”‚    â”‚    "language": "en",                                       â”‚â”‚
â”‚    â”‚    "startOffset": 0,                                       â”‚â”‚
â”‚    â”‚    "endOffset": 1245,                                      â”‚â”‚
â”‚    â”‚    "pageNumber": 1,                                        â”‚â”‚
â”‚    â”‚    "sectionTitle": "Executive Summary",                    â”‚â”‚
â”‚    â”‚    "metadata": {                                           â”‚â”‚
â”‚    â”‚      "sourceFormat": "pdf",                                â”‚â”‚
â”‚    â”‚      "extractionMethod": "pypdf",                          â”‚â”‚
â”‚    â”‚      "confidence": 0.98                                    â”‚â”‚
â”‚    â”‚    },                                                       â”‚â”‚
â”‚    â”‚    "embeddingModel": "text-embedding-3-small",             â”‚â”‚
â”‚    â”‚    "embeddingStatus": "complete",                          â”‚â”‚
â”‚    â”‚    "embeddingTimestamp": "2025-01-15T10:05:00Z",           â”‚â”‚
â”‚    â”‚    "embeddingDimensions": 1536,                            â”‚â”‚
â”‚    â”‚    "tags": ["proposal", "sales", "q1-2025"],              â”‚â”‚
â”‚    â”‚    "createdBy": "user-123",                                â”‚â”‚
â”‚    â”‚    "createdAt": "2025-01-15T10:00:00Z"                     â”‚â”‚
â”‚    â”‚  }                                                           â”‚â”‚
â”‚    â”‚                                                              â”‚â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                     â”‚
â”‚    â”Œâ”€â”€â”€ UNSTRUCTURED DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚  "unstructuredData": {                                      â”‚ â”‚
â”‚    â”‚    "embedding": [                     â† Vector (1536 dims) â”‚ â”‚
â”‚    â”‚      0.123, -0.456, 0.789, ...,                            â”‚ â”‚
â”‚    â”‚      ... 1536 total values ...                             â”‚ â”‚
â”‚    â”‚    ],                                                       â”‚ â”‚
â”‚    â”‚    "rawMetadata": {                                         â”‚ â”‚
â”‚    â”‚      "generationModel": "text-embedding-3-small",           â”‚ â”‚
â”‚    â”‚      "generationTime": "2025-01-15T10:05:00Z",             â”‚ â”‚
â”‚    â”‚      "tokenCount": 287                                     â”‚ â”‚
â”‚    â”‚    }                                                        â”‚ â”‚
â”‚    â”‚  }                                                           â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â”‚    â”Œâ”€â”€â”€ RELATIONSHIPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚    â”‚                                                              â”‚  â”‚
â”‚    â”‚  "internal_relationships": [                                â”‚  â”‚
â”‚    â”‚    {                                                        â”‚  â”‚
â”‚    â”‚      "id": "rel-parent-uuid",                              â”‚  â”‚
â”‚    â”‚      "targetShardId": "document-abc123",                   â”‚  â”‚
â”‚    â”‚      "targetShardTypeId": "c_document",                    â”‚  â”‚
â”‚    â”‚      "relationshipType": "chunk_of",                       â”‚  â”‚
â”‚    â”‚      "label": "Parent Document",                           â”‚  â”‚
â”‚    â”‚      "metadata": {                                         â”‚  â”‚
â”‚    â”‚        "isRequired": true,                                 â”‚  â”‚
â”‚    â”‚        "cascadeDelete": true,                              â”‚  â”‚
â”‚    â”‚        "chunkOrder": 1                                     â”‚  â”‚
â”‚    â”‚      },                                                     â”‚  â”‚
â”‚    â”‚      "createdAt": "2025-01-15T10:00:00Z",                  â”‚  â”‚
â”‚    â”‚      "createdBy": "system"                                 â”‚  â”‚
â”‚    â”‚    }                                                        â”‚  â”‚
â”‚    â”‚  ]                                                           â”‚  â”‚
â”‚    â”‚                                                              â”‚  â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â”‚    â”Œâ”€â”€â”€ ACCESS CONTROL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    â”‚                                                              â”‚   â”‚
â”‚    â”‚  "acl": [                                                   â”‚   â”‚
â”‚    â”‚    {                                                        â”‚   â”‚
â”‚    â”‚      "userId": "user-123",                                 â”‚   â”‚
â”‚    â”‚      "permissions": ["read", "write", "delete"],           â”‚   â”‚
â”‚    â”‚      "grantedBy": "system",                                â”‚   â”‚
â”‚    â”‚      "grantedAt": "2025-01-15T10:00:00Z"                   â”‚   â”‚
â”‚    â”‚    }                                                        â”‚   â”‚
â”‚    â”‚  ]                                                           â”‚   â”‚
â”‚    â”‚                                                              â”‚   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â”‚    "status": "active",                                             â”‚
â”‚    "createdAt": "2025-01-15T10:00:00Z",                            â”‚
â”‚    "updatedAt": "2025-01-15T10:05:00Z"                             â”‚
â”‚  }                                                                  â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. Query Patterns

### Query 1: Get All Chunks for a Document

```
SELECT c.* 
FROM document_chunks c
WHERE c.documentId = @docId 
  AND c.tenantId = @tenantId
  AND c.status != 'deleted'
ORDER BY c.chunkSequence ASC
```

**Use Case**: Load all chunks when viewing document

---

### Query 2: Find Chunks Ready for Semantic Search

```
SELECT c.id, c.name, c.documentId, c.embeddingDimensions
FROM document_chunks c
WHERE c.tenantId = @tenantId
  AND c.embeddingStatus = 'complete'
  AND c.status != 'deleted'
```

**Use Case**: Pre-filter chunks for vector search

---

### Query 3: Find Chunks Pending Embedding Generation

```
SELECT c.id, c.content, c.embeddingModel
FROM document_chunks c
WHERE c.tenantId = @tenantId
  AND c.embeddingStatus IN ('pending', 'deprecated')
  AND c.status != 'deleted'
  AND c.documentId IN (
    SELECT d.id FROM documents d
    WHERE d.tenantId = @tenantId
      AND d.status != 'deleted'
  )
LIMIT 100
```

**Use Case**: Batch embedding generation job

---

### Query 4: Find Orphaned Chunks

```
SELECT c.id, c.documentId
FROM document_chunks c
WHERE c.tenantId = @tenantId
  AND c.status != 'deleted'
  AND NOT EXISTS (
    SELECT 1 FROM documents d
    WHERE d.id = c.documentId
      AND d.tenantId = @tenantId
      AND d.status != 'deleted'
  )
```

**Use Case**: Maintenance/cleanup job

---

### Query 5: Cascade Delete All Chunks

```
UPDATE document_chunks
SET deletedAt = @now,
    deletedBy = @userId,
    status = 'deleted'
WHERE documentId = @docId
  AND tenantId = @tenantId
  AND status != 'deleted'
```

**Use Case**: Soft delete cascade

---

## 8. Database Schema Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Document Chunks                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  Table: document_chunks                                             â”‚
â”‚  Partition: /tenantId                                              â”‚
â”‚                                                                      â”‚
â”‚  Columns:                                                            â”‚
â”‚  â”œâ”€ id (UUID) ............................ Primary Key              â”‚
â”‚  â”œâ”€ tenantId (UUID) ...................... Partition Key / Index    â”‚
â”‚  â”œâ”€ userId (UUID) ........................ Creator user             â”‚
â”‚  â”œâ”€ shardTypeId (UUID) ................... c_documentChunk         â”‚
â”‚  â”œâ”€ parentShardId (UUID) ................. Parent Shard             â”‚
â”‚  â”‚                                                                   â”‚
â”‚  â”œâ”€ name (string) ........................ Chunk title             â”‚
â”‚  â”œâ”€ documentId (UUID) .................... Parent doc / Index       â”‚
â”‚  â”œâ”€ documentName (string) ................ Denormalized             â”‚
â”‚  â”œâ”€ content (string) ..................... Chunk text               â”‚
â”‚  â”œâ”€ contentLength (int) .................. Char count              â”‚
â”‚  â”œâ”€ contentHash (string) ................. SHA-256 / Index          â”‚
â”‚  â”œâ”€ chunkSequence (int) .................. Order / Index            â”‚
â”‚  â”œâ”€ chunkSize (int) ...................... Target tokens            â”‚
â”‚  â”œâ”€ startOffset (int) .................... Position in doc          â”‚
â”‚  â”œâ”€ endOffset (int) ...................... Position in doc          â”‚
â”‚  â”œâ”€ pageNumber (int) ..................... For PDFs                â”‚
â”‚  â”œâ”€ sectionTitle (string) ................ Section heading          â”‚
â”‚  â”œâ”€ language (string) .................... ISO 639-1               â”‚
â”‚  â”‚                                                                   â”‚
â”‚  â”œâ”€ embeddingModel (string) .............. Model used              â”‚
â”‚  â”œâ”€ embeddingStatus (string) / Index ..... pending|processing|...  â”‚
â”‚  â”œâ”€ embeddingTimestamp (datetime) ........ Generated               â”‚
â”‚  â”œâ”€ embeddingDimensions (int) ............ 1536, 3072, etc.       â”‚
â”‚  â”‚                                                                   â”‚
â”‚  â”œâ”€ metadata (JSON) ...................... Custom metadata          â”‚
â”‚  â”œâ”€ tags (JSON array) .................... User tags                â”‚
â”‚  â”‚                                                                   â”‚
â”‚  â”œâ”€ createdBy (UUID) ..................... Creator                 â”‚
â”‚  â”œâ”€ createdAt (datetime) ................. Timestamp               â”‚
â”‚  â”œâ”€ updatedAt (datetime) ................. Timestamp               â”‚
â”‚  â”œâ”€ deletedBy (UUID) ..................... Soft delete user       â”‚
â”‚  â”œâ”€ deletedAt (datetime) ................. Soft delete timestamp   â”‚
â”‚  â””â”€ status (string) ...................... active|deleted          â”‚
â”‚                                                                      â”‚
â”‚  Indexes:                                                            â”‚
â”‚  - PK: id                                                           â”‚
â”‚  - documentId (for parent lookup)                                   â”‚
â”‚  - tenantId (for multi-tenancy)                                    â”‚
â”‚  - embeddingStatus (for batch jobs)                                â”‚
â”‚  - (documentId, chunkSequence) (for ordered retrieval)             â”‚
â”‚  - contentHash (for deduplication)                                 â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Chunk Embeddings                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  Table: chunk_embeddings                                            â”‚
â”‚  Index Type: Vector Search (IVF-Flat, HNSW, etc.)                  â”‚
â”‚                                                                      â”‚
â”‚  Columns:                                                            â”‚
â”‚  â”œâ”€ chunkId (UUID) ...................... FK â†’ document_chunks     â”‚
â”‚  â”œâ”€ tenantId (UUID) ..................... Multi-tenant support     â”‚
â”‚  â”œâ”€ embedding (float[1536]) ............. Vector / VECTOR INDEX    â”‚
â”‚  â”‚                                                                   â”‚
â”‚  Indexes:                                                            â”‚
â”‚  - PK: chunkId                                                      â”‚
â”‚  - VECTOR INDEX: embedding (cosine similarity)                      â”‚
â”‚  - tenantId (for filtering)                                         â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**End of Diagrams**
