# Unit test failures report

Generated by `node scripts/run-unit-tests-all.mjs`

Total containers: 54
Failed: 12

Full log: [unit-test-run.log](../../unit-test-run.log)

## Failures by container

### dashboard-analytics

```
 FAIL  tests/unit/services/DashboardAnalyticsService.test.ts > DashboardAnalyticsService > recordView > should update existing view count
AssertionError: expected "vi.fn()" to be called at least once
 ❯ tests/unit/services/DashboardAnalyticsService.test.ts:119:43
    117|       await service.recordView(tenantId, dashboardId);
    118| 
    119|       expect(mockContainer.items.replace).toHaveBeenCalled();
       |                                           ^
    120|     });
    121|   });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[2/3]⎯

 FAIL  tests/unit/services/DashboardAnalyticsService.test.ts > DashboardAnalyticsService > getWidgetCache > should retrieve widget cache successfully
AssertionError: expected null to deeply equal { id: 'cache-123', …(4) }

- Expected: 
{
  "data": {
    "value": "cached-data",
  },
  "expiresAt": 2026-02-01T12:55:16.785Z,
  "id": "cache-123",
  "tenantId": "tenant-123",
  "widgetId": "widget-123",
}

+ Received: 
null

 ❯ tests/unit/services/DashboardAnalyticsService.test.ts:144:22
    142|       const result = await service.getWidgetCache(tenantId, widgetId);
    143| 
    144|       expect(result).toEqual(mockCache);
       |                      ^
    145|     });
    146| 

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[3/3]⎯


```

### data-enrichment

```

> @coder/data-enrichment@1.0.0 test:unit /home/neodyme/Documents/Castiel 2/castiel2/containers/data-enrichment
> vitest run tests/unit


 RUN  v4.0.18 /home/neodyme/Documents/Castiel 2/castiel2/containers/data-enrichment

 ❯ tests/unit/services/EnrichmentService.test.ts (0 test)

```

### forecasting

```

> @coder/forecasting@1.0.0 test:unit /home/neodyme/Documents/Castiel 2/castiel2/containers/forecasting
> vitest run tests/unit


 RUN  v4.0.18 /home/neodyme/Documents/Castiel 2/castiel2/containers/forecasting

 ❯ tests/unit/services/ForecastingService.test.ts (0 test)

 Test Files  1 failed (1)
      Tests  no tests
   Start at  11:57:18
   Duration  394ms (transform 200ms, setup 90ms, import 0ms, tests 0ms, environment 0ms)

 ELIFECYCLE  Command failed with exit code 1.
 DEPRECATED  `test.poolOptions` was removed in Vitest 4. All previous `poolOptions` are now top-level options. Please, refer to the migration guide: https://vitest.dev/guide/migration#pool-rework

⎯⎯⎯⎯⎯⎯ Failed Suites 1 ⎯⎯⎯⎯⎯⎯⎯

 FAIL  tests/unit/services/ForecastingService.test.ts [ tests/unit/services/ForecastingService.test.ts ]
Error: Cannot find package 'uuid' imported from '/home/neodyme/Documents/Castiel 2/castiel2/containers/forecasting/src/services/ForecastingService.ts'
 ❯ src/services/ForecastingService.ts:27:1
     25| } from '../types/forecasting.types';
     26| import { publishForecastEvent } from '../events/publishers/Forecasting…
     27| import { v4 as uuidv4 } from 'uuid';
       | ^
     28| import { ForecastAccuracyService } from './ForecastAccuracyService';
     29| 
 ❯ tests/unit/services/ForecastingService.test.ts:6:1

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[1/1]⎯


```

### integration-sync

```
⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[3/25]⎯

 FAIL  tests/unit/services/TokenRefreshService.test.ts > TokenRefreshService > start > should publish integration.token.check-expiring on start when enabled
 FAIL  tests/unit/services/TokenRefreshService.test.ts > TokenRefreshService > start > should not throw when start is called
 FAIL  tests/unit/services/TokenRefreshService.test.ts > TokenRefreshService > stop > should clear interval on stop
 FAIL  tests/unit/services/TokenRefreshService.test.ts > TokenRefreshService > refreshConnectionTokens > should skip when tenantId is missing
 FAIL  tests/unit/services/TokenRefreshService.test.ts > TokenRefreshService > refreshConnectionTokens > should skip when integrationId is missing
 FAIL  tests/unit/services/TokenRefreshService.test.ts > TokenRefreshService > refreshConnectionTokens > should call integration-manager refresh and publish integration.token.refreshed on success
 FAIL  tests/unit/services/TokenRefreshService.test.ts > TokenRefreshService > refreshConnectionTokens > should publish integration.token.refresh.failed and put integration to error on API failure
TypeError: () => mockIntegrationManagerClient is not a constructor
 ❯ new TokenRefreshService src/services/TokenRefreshService.ts:38:37
     36|     this.config = loadConfig();
     37|     
     38|     this.integrationManagerClient = new ServiceClient({
       |                                     ^
     39|       baseURL: this.config.services.integration_manager?.url || '',
     40|       timeout: 30000,
 ❯ tests/unit/services/TokenRefreshService.test.ts:38:15

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[4/25]⎯

 FAIL  tests/unit/services/TokenRefreshService.test.ts > TokenRefreshService > start > should publish integration.token.check-expiring on start when enabled
 FAIL  tests/unit/services/TokenRefreshService.test.ts > TokenRefreshService > start > should not throw when start is called
 FAIL  tests/unit/services/TokenRefreshService.test.ts > TokenRefreshService > stop > should clear interval on stop
 FAIL  tests/unit/services/TokenRefreshService.test.ts > TokenRefreshService > refreshConnectionTokens > should skip when tenantId is missing
 FAIL  tests/unit/services/TokenRefreshService.test.ts > TokenRefreshService > refreshConnectionTokens > should skip when integrationId is missing
 FAIL  tests/unit/services/TokenRefreshService.test.ts > TokenRefreshService > refreshConnectionTokens > should call integration-manager refresh and publish integration.token.refreshed on success
 FAIL  tests/unit/services/TokenRefreshService.test.ts > TokenRefreshService > refreshConnectionTokens > should publish integration.token.refresh.failed and put integration to error on API failure
TypeError: Cannot read properties of undefined (reading 'stop')
 ❯ tests/unit/services/TokenRefreshService.test.ts:42:19
     40| 
     41|   afterEach(async () => {
     42|     await service.stop();
       |                   ^
     43|   });
     44| 

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[5/25]⎯


```

### quality-monitoring

```

> @coder/quality-monitoring@1.0.0 test:unit /home/neodyme/Documents/Castiel 2/castiel2/containers/quality-monitoring
> vitest run tests/unit


 RUN  v4.0.18 /home/neodyme/Documents/Castiel 2/castiel2/containers/quality-monitoring

 ❯ tests/unit/services/QualityMonitoringService.test.ts (4 tests | 4 failed) 9ms
       × should record a metric successfully 5ms
       × should detect anomaly when metric exceeds threshold 1ms
       × should detect an anomaly successfully 1ms
       × should retrieve anomalies successfully 0ms

 Test Files  1 failed (1)
      Tests  4 failed (4)
   Start at  11:57:34
   Duration  311ms (transform 111ms, setup 72ms, import 80ms, tests 9ms, environment 0ms)

 ELIFECYCLE  Command failed with exit code 1.
 DEPRECATED  `test.poolOptions` was removed in Vitest 4. All previous `poolOptions` are now top-level options. Please, refer to the migration guide: https://vitest.dev/guide/migration#pool-rework

⎯⎯⎯⎯⎯⎯⎯ Failed Tests 4 ⎯⎯⎯⎯⎯⎯⎯

 FAIL  tests/unit/services/QualityMonitoringService.test.ts > QualityMonitoringService > recordMetric > should record a metric successfully
 FAIL  tests/unit/services/QualityMonitoringService.test.ts > QualityMonitoringService > recordMetric > should detect anomaly when metric exceeds threshold
 FAIL  tests/unit/services/QualityMonitoringService.test.ts > QualityMonitoringService > detectAnomaly > should detect an anomaly successfully
 FAIL  tests/unit/services/QualityMonitoringService.test.ts > QualityMonitoringService > getAnomalies > should retrieve anomalies successfully
TypeError: Cannot read properties of undefined (reading 'ai_service')
 ❯ new QualityMonitoringService src/services/QualityMonitoringService.ts:47:37
     45|     
     46|     this.aiServiceClient = new ServiceClient({
     47|       baseURL: this.config.services.ai_service?.url || '',
       |                                     ^
     48|       timeout: 30000,
     49|       retries: 3,
 ❯ tests/unit/services/QualityMonitoringService.test.ts:70:15

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[1/4]⎯


```

### risk-catalog

```
stderr | tests/unit/services/RiskCatalogService.test.ts > RiskCatalogService > updateRisk > should update a risk successfully
[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

stderr | tests/unit/services/RiskCatalogService.test.ts > RiskCatalogService > updateRisk > should handle risk not found
[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

stderr | tests/unit/services/RiskCatalogService.test.ts > RiskCatalogService > deleteRisk > should delete a risk successfully
[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

stderr | tests/unit/services/RiskCatalogService.test.ts > RiskCatalogService > enableRisk > should enable a risk successfully
[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

stderr | tests/unit/services/RiskCatalogService.test.ts > RiskCatalogService > disableRisk > should disable a risk successfully
[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.


⎯⎯⎯⎯⎯⎯⎯ Failed Tests 9 ⎯⎯⎯⎯⎯⎯⎯

 FAIL  tests/unit/services/RiskCatalogService.test.ts > RiskCatalogService > getCatalog > should retrieve catalog successfully
 FAIL  tests/unit/services/RiskCatalogService.test.ts > RiskCatalogService > getCatalog > should handle catalog not found
 FAIL  tests/unit/services/RiskCatalogService.test.ts > RiskCatalogService > createRisk > should create a risk successfully
 FAIL  tests/unit/services/RiskCatalogService.test.ts > RiskCatalogService > createRisk > should handle errors during risk creation
 FAIL  tests/unit/services/RiskCatalogService.test.ts > RiskCatalogService > updateRisk > should update a risk successfully
 FAIL  tests/unit/services/RiskCatalogService.test.ts > RiskCatalogService > updateRisk > should handle risk not found
 FAIL  tests/unit/services/RiskCatalogService.test.ts > RiskCatalogService > deleteRisk > should delete a risk successfully
 FAIL  tests/unit/services/RiskCatalogService.test.ts > RiskCatalogService > enableRisk > should enable a risk successfully
 FAIL  tests/unit/services/RiskCatalogService.test.ts > RiskCatalogService > disableRisk > should disable a risk successfully
TypeError: () => mockShardManagerClient is not a constructor
 ❯ new RiskCatalogService src/services/RiskCatalogService.ts:58:31
     56|     this.app = app;
     57|     this.config = loadConfig();
     58|     this.shardManagerClient = new ServiceClient({
       |                               ^
     59|       baseURL: this.config.services.shard_manager.url,
     60|       timeout: 30000,
 ❯ tests/unit/services/RiskCatalogService.test.ts:52:15

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[1/9]⎯


```

### secret-management

```
 ❯ EncryptionService.encryptSecretValue src/services/encryption/EncryptionService.ts:114:23
 ❯ tests/unit/services/encryption/EncryptionService.test.ts:50:22

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[36/52]⎯

 FAIL  tests/unit/services/encryption/EncryptionService.test.ts > EncryptionService > decryptSecretValue > should decrypt an encrypted secret value
EncryptionError: Encryption failed: Failed to encrypt value: this.keyManager.decryptKeyMaterial is not a function
 ❯ EncryptionService.encrypt src/services/encryption/EncryptionService.ts:60:13
     58|         throw error;
     59|       }
     60|       throw new EncryptionError(
       |             ^
     61|         `Failed to encrypt value: ${error instanceof Error ? error.mes…
     62|         error instanceof Error ? error : undefined
 ❯ EncryptionService.encryptSecretValue src/services/encryption/EncryptionService.ts:114:23
 ❯ tests/unit/services/encryption/EncryptionService.test.ts:65:25

Caused by: TypeError: this.keyManager.decryptKeyMaterial is not a function
 ❯ EncryptionService.encrypt src/services/encryption/EncryptionService.ts:33:49
 ❯ EncryptionService.encryptSecretValue src/services/encryption/EncryptionService.ts:114:23
 ❯ tests/unit/services/encryption/EncryptionService.test.ts:65:25

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[37/52]⎯

 FAIL  tests/unit/services/encryption/KeyManager.test.ts > KeyManager > getActiveKey > should retrieve the active encryption key
 FAIL  tests/unit/services/encryption/KeyManager.test.ts > KeyManager > getActiveKey > should create a new key if no active key exists
 FAIL  tests/unit/services/encryption/KeyManager.test.ts > KeyManager > rotateKey > should rotate encryption key
Error: SECRET_MASTER_KEY environment variable is required
 ❯ new KeyManager src/services/encryption/KeyManager.ts:32:13
     30|     const masterKeyEnv = process.env.SECRET_MASTER_KEY;
     31|     if (!masterKeyEnv) {
     32|       throw new Error('SECRET_MASTER_KEY environment variable is requi…
       |             ^
     33|     }
     34|     
 ❯ tests/unit/services/encryption/KeyManager.test.ts:28:18

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[38/52]⎯


```

### security-scanning

```

> @coder/security-scanning@1.0.0 test:unit /home/neodyme/Documents/Castiel 2/castiel2/containers/security-scanning
> vitest run tests/unit


 RUN  v4.0.18 /home/neodyme/Documents/Castiel 2/castiel2/containers/security-scanning

 ❯ tests/unit/services/SecurityScanningService.test.ts (0 test)

 Test Files  1 failed (1)
      Tests  no tests
   Start at  11:57:46
   Duration  335ms (transform 138ms, setup 95ms, import 0ms, tests 0ms, environment 0ms)

 ELIFECYCLE  Command failed with exit code 1.
 DEPRECATED  `test.poolOptions` was removed in Vitest 4. All previous `poolOptions` are now top-level options. Please, refer to the migration guide: https://vitest.dev/guide/migration#pool-rework

⎯⎯⎯⎯⎯⎯ Failed Suites 1 ⎯⎯⎯⎯⎯⎯⎯

 FAIL  tests/unit/services/SecurityScanningService.test.ts [ tests/unit/services/SecurityScanningService.test.ts ]
Error: Cannot find package 'uuid' imported from '/home/neodyme/Documents/Castiel 2/castiel2/containers/security-scanning/src/services/SecurityScanningService.ts'
 ❯ src/services/SecurityScanningService.ts:10:1
      8| import { loadConfig } from '../config';
      9| import { log } from '../utils/logger';
     10| import { v4 as uuidv4 } from 'uuid';
       | ^
     11| 
     12| export interface SecurityScan {
 ❯ tests/unit/services/SecurityScanningService.test.ts:6:1

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[1/1]⎯


```

### signal-intelligence

```

> @coder/signal-intelligence@1.0.0 test:unit /home/neodyme/Documents/Castiel 2/castiel2/containers/signal-intelligence
> vitest run tests/unit


 RUN  v4.0.18 /home/neodyme/Documents/Castiel 2/castiel2/containers/signal-intelligence

 ❯ tests/unit/services/SignalIntelligenceService.test.ts (0 test)

 Test Files  1 failed (1)
      Tests  no tests
   Start at  11:57:49
   Duration  293ms (transform 116ms, setup 79ms, import 0ms, tests 0ms, environment 0ms)

 ELIFECYCLE  Command failed with exit code 1.
 DEPRECATED  `test.poolOptions` was removed in Vitest 4. All previous `poolOptions` are now top-level options. Please, refer to the migration guide: https://vitest.dev/guide/migration#pool-rework

⎯⎯⎯⎯⎯⎯ Failed Suites 1 ⎯⎯⎯⎯⎯⎯⎯

 FAIL  tests/unit/services/SignalIntelligenceService.test.ts [ tests/unit/services/SignalIntelligenceService.test.ts ]
Error: Cannot find package 'uuid' imported from '/home/neodyme/Documents/Castiel 2/castiel2/containers/signal-intelligence/src/services/SignalIntelligenceService.ts'
 ❯ src/services/SignalIntelligenceService.ts:10:1
      8| import { loadConfig } from '../config';
      9| import { log } from '../utils/logger';
     10| import { v4 as uuidv4 } from 'uuid';
       | ^
     11| 
     12| export interface Signal {
 ❯ tests/unit/services/SignalIntelligenceService.test.ts:6:1

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[1/1]⎯


```

### utility-services

```

> @coder/utility-services@1.0.0 test:unit /home/neodyme/Documents/Castiel 2/castiel2/containers/utility-services
> vitest run tests/unit


 RUN  v4.0.18 /home/neodyme/Documents/Castiel 2/castiel2/containers/utility-services

 ❯ tests/unit/services/UtilityService.test.ts (0 test)

 Test Files  1 failed (1)
      Tests  no tests
   Start at  11:57:53
   Duration  443ms (transform 133ms, setup 97ms, import 0ms, tests 0ms, environment 0ms)

 ELIFECYCLE  Command failed with exit code 1.
 DEPRECATED  `test.poolOptions` was removed in Vitest 4. All previous `poolOptions` are now top-level options. Please, refer to the migration guide: https://vitest.dev/guide/migration#pool-rework

⎯⎯⎯⎯⎯⎯ Failed Suites 1 ⎯⎯⎯⎯⎯⎯⎯

 FAIL  tests/unit/services/UtilityService.test.ts [ tests/unit/services/UtilityService.test.ts ]
Error: Cannot find package 'uuid' imported from '/home/neodyme/Documents/Castiel 2/castiel2/containers/utility-services/src/services/UtilityService.ts'
 ❯ src/services/UtilityService.ts:10:1
      8| import { loadConfig } from '../config';
      9| import { log } from '../utils/logger';
     10| import { v4 as uuidv4 } from 'uuid';
       | ^
     11| 
     12| export interface ImportJob {
 ❯ tests/unit/services/UtilityService.test.ts:6:1

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[1/1]⎯


```

### web-search

```

> @coder/web-search@1.0.0 test:unit /home/neodyme/Documents/Castiel 2/castiel2/containers/web-search
> vitest run tests/unit


 RUN  v4.0.18 /home/neodyme/Documents/Castiel 2/castiel2/containers/web-search

 ❯ tests/unit/services/WebSearchService.test.ts (0 test)

 Test Files  1 failed (1)
      Tests  no tests
   Start at  11:57:55
   Duration  300ms (transform 112ms, setup 74ms, import 0ms, tests 0ms, environment 0ms)

 ELIFECYCLE  Command failed with exit code 1.
 DEPRECATED  `test.poolOptions` was removed in Vitest 4. All previous `poolOptions` are now top-level options. Please, refer to the migration guide: https://vitest.dev/guide/migration#pool-rework

⎯⎯⎯⎯⎯⎯ Failed Suites 1 ⎯⎯⎯⎯⎯⎯⎯

 FAIL  tests/unit/services/WebSearchService.test.ts [ tests/unit/services/WebSearchService.test.ts ]
Error: Cannot find package 'uuid' imported from '/home/neodyme/Documents/Castiel 2/castiel2/containers/web-search/src/services/WebSearchService.ts'
 ❯ src/services/WebSearchService.ts:10:1
      8| import { loadConfig } from '../config';
      9| import { log } from '../utils/logger';
     10| import { v4 as uuidv4 } from 'uuid';
       | ^
     11| 
     12| export interface WebSearchResult {
 ❯ tests/unit/services/WebSearchService.test.ts:6:1

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[1/1]⎯


```

### workflow-orchestrator

```
       |                      ^
    187|       expect(mockContainer.items.read).toHaveBeenCalledWith(
    188|         workflowId,

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[3/5]⎯

 FAIL  tests/unit/services/WorkflowOrchestratorService.test.ts > WorkflowOrchestratorService > getWorkflow > should handle workflow not found
AssertionError: promise resolved "null" instead of rejecting

- Expected: 
Error {
  "message": "rejected promise",
}

+ Received: 
null

 ❯ tests/unit/services/WorkflowOrchestratorService.test.ts:203:7
    201|       await expect(
    202|         service.getWorkflow(tenantId, workflowId)
    203|       ).rejects.toThrow();
       |       ^
    204|     });
    205|   });

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[4/5]⎯

 FAIL  tests/unit/services/WorkflowOrchestratorService.test.ts > WorkflowOrchestratorService > updateWorkflowStep > should update workflow step successfully
TypeError: service.updateWorkflowStep is not a function
 ❯ tests/unit/services/WorkflowOrchestratorService.test.ts:245:36
    243|       });
    244| 
    245|       const result = await service.updateWorkflowStep(tenantId, workfl…
       |                                    ^
    246| 
    247|       expect(result).toHaveProperty('id');

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[5/5]⎯


```
