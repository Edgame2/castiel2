# Logging Module Configuration
# Per ModuleImplementationGuide Section 4

# Application Insights (Plan §8.5.1, FIRST_STEPS §1); init via src/instrumentation.ts
application_insights:
  connection_string: ${APPLICATIONINSIGHTS_CONNECTION_STRING:-}
  disable: ${APPLICATIONINSIGHTS_DISABLE:-false}

# Prometheus metrics (Plan §8.5.2, §8.5.4); deployment/monitoring/README
metrics:
  path: ${METRICS_PATH:-/metrics}
  require_auth: ${METRICS_REQUIRE_AUTH:-false}
  bearer_token: ${METRICS_BEARER_TOKEN:-}

module:
  name: logging
  version: 1.0.0

server:
  port: ${PORT:-3014}
  host: ${HOST:-0.0.0.0}

# Cosmos DB Configuration (shared database, prefixed containers)
cosmos_db:
  endpoint: ${COSMOS_DB_ENDPOINT}
  key: ${COSMOS_DB_KEY}
  database_id: ${COSMOS_DB_DATABASE_ID:-castiel}
  
# Legacy database.url for backward compatibility during migration
database:
  url: ${DATABASE_URL:-}  # Not used with Cosmos DB, kept for migration period
  pool_size: 20

# Data Lake (BI/risk §3.5, DATA_LAKE_LAYOUT §4): Parquet + ML audit Blob
data_lake:
  connection_string: ${DATA_LAKE_CONNECTION_STRING:-}
  container: ${DATA_LAKE_CONTAINER:-risk}
  path_prefix: ${DATA_LAKE_PATH_PREFIX:-/risk_evaluations}
  feedback_path_prefix: ${DATA_LAKE_FEEDBACK_PATH_PREFIX:-/feedback}
  audit_path_prefix: ${DATA_LAKE_AUDIT_PATH_PREFIX:-/ml_audit}
  ml_inference_logs_prefix: ${DATA_LAKE_ML_INFERENCE_LOGS_PREFIX:-/ml_inference_logs}

rabbitmq:
  url: ${RABBITMQ_URL}
  exchange: coder_events
  queue: logging_service
  bindings:
    - "auth.#"
    - "user.#"
    - "organization.#"
    - "team.#"
    - "role.#"
    - "invitation.#"
    - "secret.#"
    - "plan.#"
    - "notification.#"
  # DataLakeCollector: risk.evaluated, ml.prediction.completed, recommendation.feedback.received → Parquet
  data_lake:
    queue: logging_data_lake
    bindings:
      - "risk.evaluated"
      - "ml.prediction.completed"
      - "recommendation.feedback.received"
  # MLAuditConsumer: risk/ml/remediation/HITL/model-monitoring → Blob audit (Plan §3.5, §10, §972, §940)
  ml_audit:
    queue: logging_ml_audit
    bindings:
      - "risk.evaluated"
      - "risk.prediction.generated"
      - "ml.prediction.completed"
      - "remediation.workflow.completed"
      - "hitl.approval.requested"
      - "hitl.approval.completed"
      - "ml.model.drift.detected"
      - "ml.model.performance.degraded"

# Storage provider
storage:
  provider: cosmos  # cosmos | elasticsearch (future)
  cosmos:
    # Cosmos DB settings are in cosmos_db section above
    
# Archive provider (cold storage)
archive:
  enabled: false
  provider: s3  # s3 | azure
  s3:
    bucket: ${S3_ARCHIVE_BUCKET:-}
    region: ${AWS_REGION:-us-east-1}
    access_key_id: ${AWS_ACCESS_KEY_ID:-}
    secret_access_key: ${AWS_SECRET_ACCESS_KEY:-}
  azure:
    connection_string: ${AZURE_STORAGE_CONNECTION_STRING:-}
    container: audit-logs

# SIEM provider (future)
siem:
  enabled: false
  provider: webhook  # splunk | datadog | webhook
  webhook:
    url: ${SIEM_WEBHOOK_URL:-}
    headers:
      Authorization: "Bearer ${SIEM_API_KEY:-}"

# Default settings (can be overridden per org)
defaults:
  capture:
    ip_address: true
    user_agent: true
    geolocation: false
  redaction:
    enabled: true
    patterns:
      - "password"
      - "secret"
      - "token"
      - "apikey"
      - "api_key"
      - "\\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Z|a-z]{2,}\\b"  # email
      - "\\b\\d{4}[- ]?\\d{4}[- ]?\\d{4}[- ]?\\d{4}\\b"  # credit card
  retention:
    default_days: 90
    min_days: 30
    max_days: 2555  # 7 years
  hash_chain:
    enabled: true
    algorithm: sha256
  alerts:
    enabled: true
    check_interval_seconds: 60

# Ingestion settings
ingestion:
  batch_size: 100
  flush_interval_ms: 1000
  buffer:
    enabled: true
    max_size: 10000
    file_path: /tmp/audit_buffer

# Rate limiting
rate_limit:
  enabled: true
  max_per_second: 1000
  burst: 2000

# Jobs
jobs:
  retention:
    enabled: true
    schedule: "0 2 * * *"  # 2 AM daily
  archive:
    enabled: false
    schedule: "0 3 * * *"  # 3 AM daily
  partition:
    enabled: true
    schedule: "0 0 25 * *"  # 25th of each month
  alerts:
    enabled: true
    schedule: "*/1 * * * *"  # Every minute

# External service URLs (from config, not hardcoded)
services:
  user_management:
    url: ${USER_MANAGEMENT_URL:-http://localhost:3000}
  notification:
    url: ${NOTIFICATION_URL:-http://localhost:3001}



