// Logging Module Database Schema
// Per ModuleImplementationGuide Section 8: Database Standards

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/logging-client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// AUDIT LOG TABLES (audit_* prefix)
// ============================================================================

/// Main audit log entries
model audit_logs {
  id              String   @id @default(cuid())
  organizationId  String   @map("organization_id")
  
  // Timestamp
  timestamp       DateTime @default(now())
  receivedAt      DateTime @default(now()) @map("received_at")
  
  // Actor
  userId          String?  @map("user_id")
  sessionId       String?  @map("session_id")
  ipAddress       String?  @map("ip_address")
  userAgent       String?  @map("user_agent")
  geolocation     Json?
  
  // Action
  action          String   // e.g., "user.login", "secret.accessed"
  category        audit_log_category
  severity        audit_log_severity
  
  // Resource
  resourceType    String?  @map("resource_type")
  resourceId      String?  @map("resource_id")
  
  // Context
  message         String
  metadata        Json     @default("{}")
  
  // Hash Chain (tamper evidence)
  previousHash    String?  @map("previous_hash")
  hash            String
  
  // Tracking
  source          String   // Module that generated log
  correlationId   String?  @map("correlation_id")
  
  createdAt       DateTime @default(now()) @map("created_at")

  @@index([organizationId, timestamp(sort: Desc)], name: "idx_audit_logs_org_time")
  @@index([userId, timestamp(sort: Desc)], name: "idx_audit_logs_user")
  @@index([action, timestamp(sort: Desc)], name: "idx_audit_logs_action")
  @@index([resourceType, resourceId], name: "idx_audit_logs_resource")
  @@index([category], name: "idx_audit_logs_category")
  @@index([severity], name: "idx_audit_logs_severity")
  @@index([timestamp], name: "idx_audit_logs_timestamp")
  @@map("audit_logs")
}

/// Retention policies for audit logs
model audit_retention_policies {
  id                String    @id @default(cuid())
  organizationId    String?   @map("organization_id") // null = global default
  
  // Scope
  category          audit_log_category?
  severity          audit_log_severity?
  
  // Retention settings
  retentionDays     Int       @map("retention_days")
  archiveAfterDays  Int?      @map("archive_after_days")
  deleteAfterDays   Int       @map("delete_after_days")
  
  // Constraints (set by Super Admin)
  minRetentionDays  Int       @default(30) @map("min_retention_days")
  maxRetentionDays  Int       @default(2555) @map("max_retention_days") // 7 years
  
  // Settings
  immutable         Boolean   @default(false) // Prevent deletion (compliance)
  
  // Audit
  createdBy         String    @map("created_by")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedBy         String    @map("updated_by")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  @@unique([organizationId, category, severity], name: "unique_policy")
  @@index([organizationId], name: "idx_retention_org")
  @@map("audit_retention_policies")
}

/// Organization-level configuration
model audit_configurations {
  id                    String   @id @default(cuid())
  organizationId        String?  @unique @map("organization_id") // null = global
  
  // Capture settings
  captureIpAddress      Boolean  @default(true) @map("capture_ip_address")
  captureUserAgent      Boolean  @default(true) @map("capture_user_agent")
  captureGeolocation    Boolean  @default(false) @map("capture_geolocation")
  
  // Redaction
  redactSensitiveData   Boolean  @default(true) @map("redact_sensitive_data")
  redactionPatterns     Json     @default("[]") @map("redaction_patterns")
  
  // Hash chain
  hashChainEnabled      Boolean  @default(true) @map("hash_chain_enabled")
  
  // Alerts
  alertsEnabled         Boolean  @default(true) @map("alerts_enabled")
  
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  @@map("audit_configurations")
}

/// Alert rules for pattern detection
model audit_alert_rules {
  id                    String    @id @default(cuid())
  organizationId        String?   @map("organization_id") // null = global
  
  name                  String
  description           String?
  enabled               Boolean   @default(true)
  
  // Conditions
  type                  audit_alert_type
  conditions            Json
  
  // Actions
  notificationChannels  Json      @default("[]") @map("notification_channels")
  
  // Audit
  createdBy             String    @map("created_by")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedBy             String    @map("updated_by")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@index([organizationId], name: "idx_alert_rules_org")
  @@index([enabled], name: "idx_alert_rules_enabled")
  @@map("audit_alert_rules")
}

/// Hash chain verification checkpoints (tenant-scoped)
model audit_hash_checkpoints {
  id                    String    @id @default(cuid())
  organizationId        String?   @map("organization_id")
  checkpointTimestamp   DateTime  @map("checkpoint_timestamp")
  lastLogId             String    @map("last_log_id")
  lastHash              String    @map("last_hash")
  logCount              BigInt    @map("log_count")
  
  // Verification
  verifiedAt            DateTime? @map("verified_at")
  verifiedBy            String?   @map("verified_by")
  status                audit_verification_status @default(PENDING)
  
  createdAt             DateTime  @default(now()) @map("created_at")

  @@index([organizationId], name: "idx_checkpoints_org")
  @@index([checkpointTimestamp], name: "idx_checkpoints_time")
  @@index([status], name: "idx_checkpoints_status")
  @@map("audit_hash_checkpoints")
}

/// Export jobs for audit logs
model audit_exports {
  id                    String    @id @default(cuid())
  organizationId        String    @map("organization_id")
  
  // Export configuration
  format                audit_export_format
  filters               Json      // Filters applied to export
  
  // Status
  status                audit_export_status @default(PENDING)
  progress              Int       @default(0) // 0-100
  
  // Result
  totalRecords          Int?      @map("total_records")
  fileUrl               String?   @map("file_url")
  fileSizeBytes         BigInt?   @map("file_size_bytes")
  expiresAt             DateTime? @map("expires_at")
  
  // Error
  errorMessage          String?   @map("error_message")
  
  // Audit
  requestedBy           String    @map("requested_by")
  createdAt             DateTime  @default(now()) @map("created_at")
  completedAt           DateTime? @map("completed_at")

  @@index([organizationId, createdAt(sort: Desc)], name: "idx_exports_org_time")
  @@index([status], name: "idx_exports_status")
  @@map("audit_exports")
}

// ============================================================================
// ENUMS
// ============================================================================

enum audit_log_category {
  ACTION   // User actions (create, update, delete)
  ACCESS   // Data access (view, download)
  SECURITY // Security events (login, permission)
  SYSTEM   // System events (startup, errors)
  CUSTOM   // Custom categories

  @@map("audit_log_category")
}

enum audit_log_severity {
  DEBUG
  INFO
  WARN
  ERROR
  CRITICAL

  @@map("audit_log_severity")
}

enum audit_alert_type {
  PATTERN   // Specific event pattern
  THRESHOLD // Count exceeds threshold
  ANOMALY   // Volume anomaly

  @@map("audit_alert_type")
}

enum audit_verification_status {
  PENDING
  VERIFIED
  FAILED

  @@map("audit_verification_status")
}

enum audit_export_format {
  CSV
  JSON

  @@map("audit_export_format")
}

enum audit_export_status {
  PENDING
  PROCESSING
  COMPLETED
  FAILED

  @@map("audit_export_status")
}



