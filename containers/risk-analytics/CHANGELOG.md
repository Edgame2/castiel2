# Changelog

All notable changes to this module will be documented in this file.

## [Unreleased]

### Changed
- **anomaly.detected (Plan §7.2):** `publishAnomalyDetected` includes `tenantId` in the payload for notification-manager; accepts optional `ownerId` (opportunity OwnerId). Callers should pass `ownerId` when available so notification-manager can notify the owner. logs-events.md updated.
- **anomaly.detected ownerId from shard (Plan §7.2):** `POST /api/v1/opportunities/:opportunityId/anomalies/detect` fetches `OwnerId` from c_opportunity via shard-manager when `services.shard_manager.url` is set and passes it to `runStatisticalDetection` and `persistAndPublishMLAnomaly`; `anomaly.detected` includes `ownerId` when shard-manager is configured.

### Fixed
- **BatchJobWorker (Plan §9.3, FIRST_STEPS §5):** Removed requirement for `data_lake.connection_string` to start the worker. outcome-sync and industry-benchmarks run without Data Lake; `data_lake` is required only at run-time when `risk-snapshot-backfill` runs (throws if unset). Enables outcome-sync in envs where Data Lake is not yet configured.

### Added
- **Observability (Plan §8.5.2):** `batch_job_duration_seconds` Histogram (label `job_name`) in `BatchJobWorker` for `risk-snapshot-backfill` and `outcome-sync`; matches deployment/monitoring/README and batch-jobs.json dashboard.
- **Data quality in evaluation (Plan §11.6, §10 task 906):** `dataQuality: { score, completenessPct, missingCritical, stalenessDays }` in risk evaluation and evaluation API (`GET /api/v1/risk/evaluations/:evaluationId`, `GET /api/v1/risk/opportunities/:opportunityId/latest-evaluation`); used by trust-level. `risk.evaluated` includes full `dataQuality`.
- **Competitive intel (Plan §10 Phase 1, §3.1.1–3.1.2):** `cosmos_db.containers.competitor_tracking` (risk_competitor_tracking), `cosmos_db.containers.competitors` (competitors). `CompetitiveIntelligenceService.getCompetitorsForOpportunity`, `trackCompetitor`, `getDashboard`, `analyzeWinLossByCompetitor`. `GET /api/v1/opportunities/:opportunityId/competitors` returns competitors from risk_competitor_tracking. `POST /api/v1/competitors/:id/track` (body `opportunityId`, optional `competitorName`, `mentionCount`, `sentiment`, `winLikelihood`) upserts risk_competitor_tracking. `GET /api/v1/competitive-intelligence/dashboard` returns totalOpportunitiesWithCompetitors, totalMentions, topCompetitorsByMentions, recentMentionCount, winLoss (stub until c_opportunity IsClosed/IsWon). `GET /api/v1/analytics/competitive-win-loss` returns byCompetitor (competitorId, competitorName, wins, losses, winRate), totalWins, totalLosses, overallWinRate (wins/losses stubbed until c_opportunity IsClosed/IsWon).
- **Risk explainability (Plan §4.1, §11.2):** `GET /api/v1/opportunities/:opportunityId/risk-explainability` returns evaluationId, opportunityId, riskScore, topDrivers (feature, contribution, direction) derived from latest evaluation detectedRisks.
- **Win-probability explain (Plan §905, §11.2):** `GET /api/v1/opportunities/:opportunityId/win-probability/explain` proxies to ml-service `POST /api/v1/ml/win-probability/explain`; returns `{ topDrivers: [{ feature, contribution, direction }] }`. Requires `services.ml_service.url`.
- **Health (Plan §11.7):** `/health` includes `lastRiskSnapshotBackfillAt` (ISO timestamp or null). Set when `risk-snapshot-backfill` completes in BatchJobWorker.
- **Observability (Plan §8.5.2):** `risk_evaluations_total` incremented in `RiskEvaluationService` when `risk.evaluated` is published after a completed evaluation.
- `GET /api/v1/opportunities/:opportunityId/win-probability` (FIRST_STEPS §8, Plan §4.1): proxies to ml-service `POST /api/v1/ml/win-probability/predict`; returns `{ probability }`. Requires `services.ml_service.url`.
- `GET /api/v1/opportunities/:opportunityId/risk-velocity` (FIRST_STEPS §8, Plan §4.1): EarlyWarningService.calculateRiskVelocity; computes velocity (riskScore change per day) and acceleration from risk_snapshots; returns `{ velocity, acceleration?, dataPoints }`.
- `GET /api/v1/opportunities/:opportunityId/risk-predictions` (FIRST_STEPS §8, Plan §4.1): EarlyWarningService.predictRiskTrajectory; reads 30/60/90-day horizons from risk_predictions; returns stub when none. Config `cosmos_db.containers.predictions` (risk_predictions).
- `POST /api/v1/opportunities/:opportunityId/risk-predictions/generate` (FIRST_STEPS §8, Plan §4.1, §875): EarlyWarningService.generatePredictions; when `feature_flags.early_warning_lstm` and `services.ml_service.url`, builds sequence from getSnapshots (last 30 days, [riskScore,0,0]), calls ml-service `POST /api/v1/ml/risk-trajectory/predict`; if confidence≥0.5 uses LSTM (modelId `risk-trajectory-lstm`), else rules (latest risk + velocity); modelId `rules` when LSTM unavailable or confidence<0.5.
- **risk.prediction.generated (Plan §10):** Published when `generatePredictions` succeeds. Payload: predictionId, opportunityId, horizons, modelId, predictionDate. Logging MLAuditConsumer consumes.
- **Config (Plan §895):** `features` in `config/schema.json` for feature flags (key → boolean). `features: {}` in default.yaml. `azure_ml` owned by ml-service; risk-analytics uses ml-service for ML.
- **Config (Plan §8.1, §895):** `feature_flags` (early_warning_lstm, industry_models, competitive_intelligence, anomaly_detection, prescriptive_remediation, executive_dashboards, hitl_approvals) and `thresholds` (early_warning_days_inactivity, risk_velocity_alert, hitl_risk_min, hitl_deal_min) in risk-analytics config; env overrides (e.g. EARLY_WARNING_LSTM_ENABLED). Coercion for "true"/"false" and numeric strings in loadConfig.
- **GET /api/v1/risk-analysis/tenant/prioritized-opportunities** (Plan §941, §1024): Prioritized opportunities for manager "Recommended today". Rank by revenue-at-risk × risk × early-warning; `PrioritizedOpportunitiesService` from `risk_revenue_at_risk` (latest per opp) and `risk_warnings` (max severity); `suggestedAction` null until Phase 2. Consumed by dashboard-analytics GET /dashboards/manager/prioritized.
- **GET /api/v1/opportunities/:opportunityId/stakeholder-graph** (Plan §924): `StakeholderGraphService` builds graph from shard-manager: has_contact, has_stakeholder (opportunity→contact), reports_to (contact→contact). Returns nodes (id, type, label?), edges (source, target, relationshipType). Centrality via Azure ML: Phase 2. Config: `services.shard_manager.url`.
- **POST /api/v1/opportunities/:opportunityId/quick-actions** (Plan §942, §11.10): create_task, log_activity, start_remediation. Body `{ action, payload? }`. Publishes `opportunity.quick_action.requested`; returns 202 Accepted. Config: `services.recommendations.url` (optional, for future start_remediation sync). Event documented in logs-events.md.
- **Anomalies (Plan §920):** `cosmos_db.containers.anomaly_alerts` (risk_anomaly_alerts). `AnomalyDetectionService.getAnomalies(opportunityId, tenantId)` reads from risk_anomaly_alerts (partition tenantId). `GET /api/v1/opportunities/:opportunityId/anomalies` returns AnomalyAlert[] (id, opportunityId, anomalyType, subtype?, severity, description, detectedAt, details). `publishAnomalyDetected` in RiskAnalyticsEventPublisher for `anomaly.detected` (when detection is implemented). Event documented in logs-events.md.
- **Statistical anomaly detection (Plan §920):** `AnomalyDetectionService.runStatisticalDetection(opportunityId, tenantId)`: Z-score on recent riskScore from risk_snapshots (fallback risk_evaluations); if ≥3 scores and zScore ≥ 2 → high, ≥ 1.5 → medium; upserts to risk_anomaly_alerts and publishes `anomaly.detected`. `POST /api/v1/opportunities/:opportunityId/anomalies/detect` returns `{ detected, alert? }`. `anomaly_alerts` added to `initializeDatabase` containers.
- **ML anomaly detection (Plan §5.5):** When `services.ml_service.url` and `feature_flags.anomaly_detection`, `POST .../anomalies/detect` also calls ml-service `POST /api/v1/ml/anomaly/predict` (Isolation Forest). `persistAndPublishMLAnomaly(opportunityId, tenantId, { isAnomaly, anomalyScore })`: if isAnomaly==-1 or anomalyScore>0.5, upserts to risk_anomaly_alerts (anomalyType `ml`, subtype `isolation_forest`), publishes `anomaly.detected`. Statistical and ML results merged (detected=true if either finds; alert from first).
- **Sentiment trends (Plan §921):** `cosmos_db.containers.sentiment_trends` (risk_sentiment_trends). `SentimentTrendsService.getSentimentTrends(opportunityId, tenantId)` reads from risk_sentiment_trends (partition tenantId). `GET /api/v1/opportunities/:opportunityId/sentiment-trends` returns `{ trends: [{ period, score, sampleSize }] }`. **Consumer:** `sentiment.trends.updated` (ai-insights or data-enrichment) → RiskAnalyticsEventConsumer upserts to risk_sentiment_trends; binding and `sentiment_trends` in `initializeDatabase` added. Event documented in logs-events.md.
- **Win/loss reasons (Plan §11.8, §943):** `cosmos_db.containers.win_loss_reasons` (risk_win_loss_reasons). `CompetitiveIntelligenceService.recordWinLossReasons`, `getWinLossReasons`. `PUT /api/v1/opportunities/:opportunityId/win-loss-reasons` (body: lossReason?, winReason?, competitorId?), `GET /api/v1/opportunities/:opportunityId/win-loss-reasons`. Schema: `lossReason`, `winReason`, `competitorId` added to c_opportunity in BI_SALES_RISK_SHARD_SCHEMAS.md; ingestion feeds win/loss analytics.
- **At-risk taxonomy (Plan §11.11, §944):** `atRiskReasons: string[]` in risk evaluations and risk_snapshots; derived from `detectedRisks.riskName`. `risk.evaluated` includes atRiskReasons; `RiskSnapshotService.upsertFromEvent` and `upsertFromDataLakeRow` persist atRiskReasons. `GET /api/v1/risk-analysis/tenant/top-at-risk-reasons` (query limit?) aggregates from risk_evaluations for "Top at-risk reasons" dashboard widget. `AtRiskReasonsService.getTopAtRiskReasons`.
- **Peer deal comparison (Plan §11.12, §945):** `BenchmarkingService.getSimilarWonDeals(tenantId, opportunityId)`: similar by industry and size band (0.5×–2× amount); returns `{ count, winRate, medianCycleTimeDays, p25CloseAmount }`. `GET /api/v1/opportunities/:opportunityId/similar-won-deals`. Uses shard-manager c_opportunity; config `services.shard_manager.url`.
- **Industry benchmarks (Plan §953):** `cosmos_db.containers.industry_benchmarks` (analytics_industry_benchmarks, partition industryId). `IndustryBenchmarkService`: `getBenchmark(industryId, period?)`, `compareToBenchmark(opportunityId, tenantId)`, `calculateAndStore(tenantId, options?)`. `GET /api/v1/industries/:industryId/benchmarks` (query period?), `GET /api/v1/opportunities/:opportunityId/benchmark-comparison`. BatchJobWorker handles `industry-benchmarks` job: `workflow.job.trigger` metadata `tenantId`/`tenantIds`, `industryIds`, `period`; calls `calculateAndStore`; `batch_job_duration_seconds` label `job_name: industry-benchmarks`. Config: `services.shard_manager.url`; tenant list from `metadata.tenantIds`/`metadata.tenantId` or `outcome_sync.tenant_ids`.
- **BatchJobWorker: risk-clustering, account-health, propagation, model-monitoring (Plan §915, §940):** Handlers for `workflow.job.trigger` jobs `risk-clustering`, `account-health`, `propagation`, `model-monitoring`. risk-clustering, account-health, propagation call `computeAndPersistForTenant` (propagation stub: no persistence until graph + Azure ML). **model-monitoring:** calls ml-service `POST /api/v1/ml/model-monitoring/run` with `{ tenantIds }` (resolved from metadata.tenantIds / metadata.tenantId / outcome_sync.tenant_ids); requires `services.ml_service.url`. ml-service `ModelMonitoringService.runForTenants` stub (drift PSI + performance Brier/MAE, `ml.model.drift.detected` / `ml.model.performance.degraded` when implemented). Each publishes `workflow.job.completed`, `batch_job_duration_seconds` (job_name).
- **Risk clustering (Plan §914, §915):** `cosmos_db.containers.clusters` (risk_clusters), `association_rules` (risk_association_rules). `RiskClusteringService.identifyRiskClusters(tenantId)`, `findAssociationRules(tenantId)` read from Cosmos; return [] when empty. **Batch job (risk-clustering):** `RiskClusteringService.computeAndPersistForTenant(tenantId)` — heuristic bands from risk_revenue_at_risk (low/medium/high by riskScore), persists 3 clusters to risk_clusters; publishes `risk.cluster.updated` (clusterIds, ruleCount). Azure ML DBSCAN/K-Means + Apriori TBD. BatchJobWorker uses metadata.tenantIds / metadata.tenantId or `outcome_sync.tenant_ids`. `GET /api/v1/risk-clustering/clusters`, `GET /api/v1/risk-clustering/association-rules`, `POST /api/v1/risk-clustering/trigger`. OpenAPI updated.
- **Account health (Plan §917):** `cosmos_db.containers.account_health` (risk_account_health). `AccountHealthService.calculateAccountHealth(accountId, tenantId)` reads from Cosmos (id=tenantId_accountId, partition tenantId); 404 when not found. `GET /api/v1/accounts/:id/health`. **Batch job (account-health):** `AccountHealthService.computeAndPersistForTenant(tenantId)` — builds accountId→opportunities from shard-manager c_opportunity, aggregates risk from risk_revenue_at_risk, upserts risk_account_health. BatchJobWorker uses metadata.tenantIds / metadata.tenantId or `outcome_sync.tenant_ids`. OpenAPI updated.
- **Risk propagation (Plan §916):** `RiskPropagationService.analyzeRiskPropagation(opportunityId, tenantId)`. Stub returns `{ opportunityId, tenantId, propagatedRisk?, affectedNodeIds, _stub: true }` until graph + Azure ML batch (NetworkX) wired. `GET /api/v1/risk-propagation/opportunities/:id`. **Batch job (propagation):** `RiskPropagationService.computeAndPersistForTenant(tenantId)` — queries `risk_revenue_at_risk` for opportunityIds, calls `analyzeRiskPropagation` per opp (stub; no persistence until graph + Azure ML). BatchJobWorker uses metadata.tenantIds / metadata.tenantId or `outcome_sync.tenant_ids`; publishes `workflow.job.completed`. OpenAPI updated.
- **Outcome feedback on shard update (Plan §904):** When `outcome_feedback.publish_on_shard_update` is true (default), RiskAnalyticsEventConsumer on `shard.updated` and `integration.opportunity.updated` fetches the opportunity shard from shard-manager; if `IsClosed` and `CloseDate` in the last 24h, publishes `opportunity.outcome.recorded` (in addition to outcome-sync job). Config: `outcome_feedback.publish_on_shard_update`, `services.shard_manager.url`. Requires `publishOpportunityOutcomeRecorded` (event publisher).

## [1.3.0] - 2026-01-23

### Fixed
- **RiskAnalyticsEventConsumer**: `error: any` → `error: unknown` and type guards in all handler catches; null-safe `event?.data` for `integration.opportunity.updated`, `workflow.risk.analysis.requested`, `workflow.risk.scoring.requested` with guards for `opportunityId`/`tenantId`; `handleRiskCatalogEvent` uses type guards for err; `workflow.risk.scoring.requested` passes `{ ...modelSelection, workflowId }` instead of `(modelSelection as any).workflowId`; `closeEventConsumer` now calls `await consumer.stop()` before clearing.
- **RiskEvaluationService**: `error: any` → `error: unknown` and type guards in all catches (getLearnedWeights, getModelSelection, getRiskCatalog, getOpportunityShard, ML scoring inner, evaluateRisk, detectRisksRuleBased, detectRisksAI, detectRisksHistorical, getHistoricalEvaluation, detectRisksSemantic, performMLRiskScoring, storeEvaluation, calculateRevenueAtRisk).
- **risk-analytics routes**: all `error: any` → `error: unknown`; `statusCode`/`message` via `(error as { statusCode?: number })?.statusCode` and `error instanceof Error ? error.message : String(error)` in every route catch (includes get-simulations).
- **Services** `error: any` → `error: unknown` and type guards: EarlyWarningService, RiskExplainabilityService, RiskAIValidationService, TrustLevelService, DataQualityService, SimulationService, BenchmarkingService, QuotaService, RevenueAtRiskService, RiskCatalogService (ensureShardType inner, ensureShardType outer, getShardTypeId, getCatalog, createCustomRisk, updateRisk, duplicateRisk, setRiskEnabledForTenant, deleteRisk, getPonderation, setPonderation).

## [1.2.0] - 2026-01-23

### Added
- Risk catalog triggers (MISSING_FEATURES 4.1): consume `risk.catalog.updated`, `risk.catalog.enabled`, `risk.catalog.disabled`; re-evaluate opportunities whose evaluations reference the changed risk (query `risk_evaluations` by `detectedRisks[].riskId`). Config: `auto_evaluation.trigger_on_risk_catalog_update` (default true), `max_reevaluations_per_catalog_event` (default 50, max 200).

## [1.1.0] - 2026-01-23

### Added
- Automatic risk evaluation triggers (MISSING_FEATURES 4.1): `opportunity.updated`, `shard.created`; `shard.updated` and `integration.opportunity.updated` now honor `auto_evaluation.trigger_on_shard_update` and `auto_evaluation.trigger_on_opportunity_update`
- `shard_updated` trigger value for evaluations from `shard.updated` events
- Historical pattern learning (MISSING_FEATURES 4.5): `detectRisksHistorical` uses search-service vector search for similar opportunities when `services.search_service.url` is configured; falls back to shard-manager attribute-based query (stage, amount) when search_service is unconfigured or vector search fails
- ML-based risk scoring integration (MISSING_FEATURES 4.2): `evaluateRisk` applies ML combined score to `riskScore` and `revenueAtRisk` when `weights.ml > 0.3`; `RiskEvaluationResult.mlRiskScore` included when ML is used; relies on `POST /api/v1/ml/risk-scoring/predict`
- `GET /api/v1/risk/opportunities/:opportunityId/latest-evaluation` (MISSING_FEATURES 5.1): returns latest risk evaluation for an opportunity; used by forecasting for risk-adjusted revenue
- Assumption tracking & display (MISSING_FEATURES 4.3): `assumptions` consistently populated in all evaluations via `buildAssumptions`; OpenAPI schema `RiskEvaluationAssumptions` and evaluation 200 responses document it for UI display (dataQuality.issues, staleness.isStale, missingDataWarnings)

### Changed
- `shard.updated` and `shard.created` use `event.data.opportunityId ?? event.data.shardId` for opportunityId
- Workflow-triggered and integration.sync.completed handlers unchanged; only auto triggers respect `auto_evaluation`

## [1.0.0] - 2026-01-23

### Added
- Initial migration from old_code/
- Risk evaluation service with rule-based, AI-powered, and historical pattern matching
- Risk catalog service for global, industry, and tenant-specific risk management
- Revenue at risk service for calculating revenue at risk at opportunity, portfolio, team, and tenant levels
- Quota service for quota definitions and performance tracking
- Early warning service for detecting early-warning signals (stage stagnation, activity drop, stakeholder churn, risk acceleration)
- Benchmarking service for calculating win rates, closing times, and deal size benchmarks
- Simulation service for running risk simulations with modified scenarios
- Data quality service for validating data quality for risk evaluations
- Trust level service for calculating trust levels for risk evaluations
- AI validation service for validating AI-generated risk evaluations
- Explainability service for generating explainability for risk evaluations
- Complete API routes for all services
- Event publishing and consumption for async workflows
- CAIS integration for adaptive learning weights
